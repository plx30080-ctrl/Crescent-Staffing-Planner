<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crescent Staffing Planner</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 8px;
            font-size: 13px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-primary:hover {
            background: #f5f7ff;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }

        .content {
            padding: 16px;
        }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 8px 16px;
            background: none;
            border: none;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        /* Shift Info Bar */
        .shift-info {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .shift-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .shift-info-item label {
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
        }

        .shift-info-item input,
        .shift-info-item select {
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
        }

        .save-status {
            margin-left: auto;
            font-size: 11px;
            color: #10b981;
            font-weight: 600;
        }

        /* Compact Table Layout */
        .staffing-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .staffing-table th {
            background: #f9fafb;
            padding: 6px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .staffing-table td {
            padding: 4px 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .staffing-table tr:hover {
            background: #f9fafb;
        }

        .staffing-table tr.waitlist-row {
            background: #fffbeb;
        }

        .staffing-table tr.waitlist-row:hover {
            background: #fef3c7;
        }

        .line-cell {
            font-weight: 700;
            color: #667eea;
            font-size: 14px;
            width: 40px;
        }

        .lead-cell {
            font-weight: 600;
            color: #374151;
            min-width: 100px;
        }

        .position-cell {
            min-width: 120px;
        }

        .position-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 12px;
        }

        .position-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .checkbox-cell {
            text-align: center;
            width: 50px;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 4px;
        }

        .badge-new {
            background: #dbeafe;
            color: #1e40af;
        }

        .stats-bar {
            background: #f9fafb;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        /* Setup Form */
        .setup-form {
            display: grid;
            gap: 16px;
        }

        .form-section {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .form-section h3 {
            font-size: 16px;
            color: #111827;
            margin-bottom: 12px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Reporting View */
        .report-controls {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .report-list {
            display: grid;
            gap: 12px;
        }

        .report-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .report-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .report-item h4 {
            font-size: 14px;
            color: #111827;
            margin-bottom: 4px;
        }

        .report-item p {
            font-size: 12px;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state h3 {
            font-size: 16px;
            color: #374151;
            margin-bottom: 8px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            font-size: 18px;
            color: #111827;
            margin-bottom: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            justify-content: flex-end;
        }

        .core-associates-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .core-associate-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .core-associate-info {
            flex: 1;
        }

        .core-associate-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 2px;
            font-size: 13px;
        }

        .core-associate-notes {
            font-size: 11px;
            color: #6b7280;
        }

        .firebase-config {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .firebase-config h4 {
            color: #92400e;
            margin-bottom: 8px;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .staffing-table {
                font-size: 11px;
            }

            .position-input {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase configuration
        const FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        let db = null;
        let isFirebaseConfigured = false;

        // Check if Firebase is configured
        try {
            const configuredKeys = Object.values(FIREBASE_CONFIG).filter(v => !v.startsWith('YOUR_'));
            if (configuredKeys.length === Object.keys(FIREBASE_CONFIG).length) {
                firebase.initializeApp(FIREBASE_CONFIG);
                db = firebase.firestore();
                isFirebaseConfigured = true;
                console.log('Firebase initialized successfully');
            } else {
                console.warn('Firebase not configured. Using localStorage only.');
            }
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Storage utilities
        const storage = {
            save: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            load: (key, defaultValue = null) => {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            },
            remove: (key) => localStorage.removeItem(key)
        };

        function App() {
            const [activeTab, setActiveTab] = useState('staffing');
            const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
            const [currentShift, setCurrentShift] = useState('Day');
            const [lines, setLines] = useState([]);
            const [waitlist, setWaitlist] = useState([]);
            const [coreAssociates, setCoreAssociates] = useState({});
            const [saveStatus, setSaveStatus] = useState('');
            const saveTimeoutRef = useRef(null);

            // Load core associates from localStorage
            useEffect(() => {
                const savedCoreAssociates = storage.load('coreAssociates', {});
                setCoreAssociates(savedCoreAssociates);
            }, []);

            // Save core associates to localStorage
            useEffect(() => {
                storage.save('coreAssociates', coreAssociates);
            }, [coreAssociates]);

            // Auto-save functionality
            useEffect(() => {
                if (lines.length === 0) return;

                // Clear existing timeout
                if (saveTimeoutRef.current) {
                    clearTimeout(saveTimeoutRef.current);
                }

                // Set new timeout for auto-save
                saveTimeoutRef.current = setTimeout(() => {
                    handleAutoSave();
                }, 2000); // Save 2 seconds after last change

                return () => {
                    if (saveTimeoutRef.current) {
                        clearTimeout(saveTimeoutRef.current);
                    }
                };
            }, [lines, waitlist, currentDate, currentShift]);

            const handleAutoSave = async () => {
                const staffingData = {
                    date: currentDate,
                    shift: currentShift,
                    lines: lines,
                    waitlist: waitlist,
                    lastUpdated: new Date().toISOString()
                };

                // Always save to localStorage
                storage.save(`staffing_${currentDate}_${currentShift}`, staffingData);

                // Save to Firebase if configured
                if (isFirebaseConfigured && db) {
                    try {
                        const docId = `${currentDate}_${currentShift}`;
                        await db.collection('staffing').doc(docId).set(staffingData);
                        setSaveStatus('Saved to cloud ✓');
                    } catch (error) {
                        console.error('Firebase save error:', error);
                        setSaveStatus('Saved locally only');
                    }
                } else {
                    setSaveStatus('Saved locally');
                }

                // Clear status after 3 seconds
                setTimeout(() => setSaveStatus(''), 3000);
            };

            const loadStaffingData = async (date, shift) => {
                // Try Firebase first
                if (isFirebaseConfigured && db) {
                    try {
                        const docId = `${date}_${shift}`;
                        const doc = await db.collection('staffing').doc(docId).get();
                        if (doc.exists) {
                            const data = doc.data();
                            setLines(data.lines || []);
                            setWaitlist(data.waitlist || []);
                            return;
                        }
                    } catch (error) {
                        console.error('Firebase load error:', error);
                    }
                }

                // Fallback to localStorage
                const localData = storage.load(`staffing_${date}_${shift}`, null);
                if (localData) {
                    setLines(localData.lines || []);
                    setWaitlist(localData.waitlist || []);
                } else {
                    setLines([]);
                    setWaitlist([]);
                }
            };

            const handleDateChange = (newDate) => {
                setCurrentDate(newDate);
                loadStaffingData(newDate, currentShift);
            };

            const handleShiftChange = (newShift) => {
                setCurrentShift(newShift);
                loadStaffingData(currentDate, newShift);
            };

            const handleSetupShift = (shiftData) => {
                const newLines = shiftData.lines.map(line => ({
                    id: Date.now() + Math.random(),
                    letter: line.letter,
                    lead: line.lead,
                    needed: parseInt(line.needed),
                    positions: Array(parseInt(line.needed)).fill(null).map((_, idx) => ({
                        id: Date.now() + Math.random() + idx,
                        name: '',
                        isNew: false
                    }))
                }));

                setLines(newLines);
                setWaitlist([]);
                setActiveTab('staffing');
            };

            const handleUpdatePosition = (lineId, positionId, name, isNew) => {
                setLines(prev => prev.map(line => {
                    if (line.id === lineId) {
                        return {
                            ...line,
                            positions: line.positions.map(pos =>
                                pos.id === positionId
                                    ? { ...pos, name: name.trim(), isNew }
                                    : pos
                            )
                        };
                    }
                    return line;
                }));
            };

            const handleUpdateWaitlistItem = (itemId, name, isNew) => {
                setWaitlist(prev => prev.map(item =>
                    item.id === itemId ? { ...item, name: name.trim(), isNew } : item
                ));
            };

            const handleAddWaitlistItem = () => {
                setWaitlist(prev => [...prev, {
                    id: Date.now() + Math.random(),
                    name: '',
                    isNew: false
                }]);
            };

            const handleRemoveWaitlistItem = (itemId) => {
                setWaitlist(prev => prev.filter(item => item.id !== itemId));
            };

            const handleAddCoreAssociate = (lead, associate) => {
                setCoreAssociates(prev => ({
                    ...prev,
                    [lead]: [...(prev[lead] || []), associate]
                }));
            };

            const handleRemoveCoreAssociate = (lead, index) => {
                setCoreAssociates(prev => ({
                    ...prev,
                    [lead]: prev[lead].filter((_, i) => i !== index)
                }));
            };

            const handleExport = () => {
                const data = {
                    date: currentDate,
                    shift: currentShift,
                    lines,
                    waitlist,
                    exportedAt: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `staffing-${currentDate}-${currentShift}.json`;
                a.click();
            };

            const handleClearAll = () => {
                if (confirm('Clear current shift data? This cannot be undone.')) {
                    setLines([]);
                    setWaitlist([]);
                }
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>Crescent Staffing Planner</h1>
                        <div className="header-actions">
                            {lines.length > 0 && (
                                <>
                                    <button className="btn btn-secondary" onClick={handleExport}>
                                        Export
                                    </button>
                                    <button className="btn btn-danger" onClick={handleClearAll}>
                                        Clear
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    <div className="content">
                        <div className="tabs">
                            <button
                                className={`tab ${activeTab === 'staffing' ? 'active' : ''}`}
                                onClick={() => setActiveTab('staffing')}
                            >
                                Staffing
                            </button>
                            <button
                                className={`tab ${activeTab === 'reporting' ? 'active' : ''}`}
                                onClick={() => setActiveTab('reporting')}
                            >
                                Reports
                            </button>
                            <button
                                className={`tab ${activeTab === 'setup' ? 'active' : ''}`}
                                onClick={() => setActiveTab('setup')}
                            >
                                Setup
                            </button>
                            <button
                                className={`tab ${activeTab === 'core' ? 'active' : ''}`}
                                onClick={() => setActiveTab('core')}
                            >
                                Core Team
                            </button>
                        </div>

                        {activeTab === 'staffing' && (
                            <StaffingView
                                lines={lines}
                                waitlist={waitlist}
                                currentDate={currentDate}
                                currentShift={currentShift}
                                saveStatus={saveStatus}
                                onDateChange={handleDateChange}
                                onShiftChange={handleShiftChange}
                                onUpdatePosition={handleUpdatePosition}
                                onUpdateWaitlistItem={handleUpdateWaitlistItem}
                                onAddWaitlistItem={handleAddWaitlistItem}
                                onRemoveWaitlistItem={handleRemoveWaitlistItem}
                            />
                        )}

                        {activeTab === 'reporting' && (
                            <ReportingView
                                onLoadShift={(date, shift) => {
                                    setCurrentDate(date);
                                    setCurrentShift(shift);
                                    loadStaffingData(date, shift);
                                    setActiveTab('staffing');
                                }}
                            />
                        )}

                        {activeTab === 'setup' && (
                            <SetupView
                                onSetupShift={handleSetupShift}
                                coreAssociates={coreAssociates}
                            />
                        )}

                        {activeTab === 'core' && (
                            <CoreAssociatesView
                                coreAssociates={coreAssociates}
                                onAddCoreAssociate={handleAddCoreAssociate}
                                onRemoveCoreAssociate={handleRemoveCoreAssociate}
                            />
                        )}
                    </div>
                </div>
            );
        }

        function StaffingView({
            lines,
            waitlist,
            currentDate,
            currentShift,
            saveStatus,
            onDateChange,
            onShiftChange,
            onUpdatePosition,
            onUpdateWaitlistItem,
            onAddWaitlistItem,
            onRemoveWaitlistItem
        }) {
            if (lines.length === 0) {
                return (
                    <div className="empty-state">
                        <h3>No Shift Configured</h3>
                        <p>Go to "Setup" to create today's staffing chart.</p>
                    </div>
                );
            }

            const totalPositions = lines.reduce((sum, line) => sum + line.needed, 0);
            const filledPositions = lines.reduce((sum, line) =>
                sum + line.positions.filter(p => p.name.trim()).length, 0
            );
            const newAssociates = lines.reduce((sum, line) =>
                sum + line.positions.filter(p => p.name.trim() && p.isNew).length, 0
            );

            return (
                <>
                    {!isFirebaseConfigured && (
                        <div className="firebase-config">
                            <h4>⚠️ Firebase Not Configured</h4>
                            <p>Data is being saved locally only. To enable cloud sync and remote access, please configure Firebase in the code.</p>
                        </div>
                    )}

                    <div className="shift-info">
                        <div className="shift-info-item">
                            <label>Date</label>
                            <input
                                type="date"
                                value={currentDate}
                                onChange={(e) => onDateChange(e.target.value)}
                            />
                        </div>
                        <div className="shift-info-item">
                            <label>Shift</label>
                            <select value={currentShift} onChange={(e) => onShiftChange(e.target.value)}>
                                <option>Day</option>
                                <option>Night</option>
                                <option>Swing</option>
                            </select>
                        </div>
                        {saveStatus && (
                            <div className="save-status">{saveStatus}</div>
                        )}
                    </div>

                    <div className="stats-bar">
                        <div>
                            <strong style={{ color: '#10b981', fontSize: '14px' }}>{filledPositions}</strong> / {totalPositions} filled
                            {newAssociates > 0 && <span style={{ marginLeft: '12px', color: '#3b82f6' }}>• {newAssociates} new</span>}
                            {waitlist.length > 0 && <span style={{ marginLeft: '12px', color: '#f59e0b' }}>• {waitlist.filter(w => w.name.trim()).length} waiting</span>}
                        </div>
                    </div>

                    <div style={{ overflowX: 'auto' }}>
                        <table className="staffing-table">
                            <thead>
                                <tr>
                                    <th>Line</th>
                                    <th>Lead</th>
                                    <th>Pos</th>
                                    <th>Associate Name</th>
                                    <th>New</th>
                                </tr>
                            </thead>
                            <tbody>
                                {lines.map(line => (
                                    line.positions.map((position, idx) => (
                                        <tr key={position.id}>
                                            {idx === 0 && (
                                                <>
                                                    <td className="line-cell" rowSpan={line.needed}>
                                                        {line.letter}
                                                    </td>
                                                    <td className="lead-cell" rowSpan={line.needed}>
                                                        {line.lead}
                                                    </td>
                                                </>
                                            )}
                                            <td>{idx + 1}</td>
                                            <td className="position-cell">
                                                <input
                                                    type="text"
                                                    className="position-input"
                                                    value={position.name}
                                                    onChange={(e) => onUpdatePosition(line.id, position.id, e.target.value, position.isNew)}
                                                    placeholder="Type name..."
                                                />
                                            </td>
                                            <td className="checkbox-cell">
                                                <input
                                                    type="checkbox"
                                                    checked={position.isNew}
                                                    onChange={(e) => onUpdatePosition(line.id, position.id, position.name, e.target.checked)}
                                                />
                                            </td>
                                        </tr>
                                    ))
                                ))}

                                {/* Waitlist Section */}
                                <tr>
                                    <td colspan="5" style={{ height: '8px', background: '#f9fafb' }}></td>
                                </tr>
                                <tr style={{ background: '#fffbeb' }}>
                                    <td colspan="5" style={{ fontWeight: '600', padding: '8px' }}>
                                        WAITLIST
                                        <button
                                            className="btn btn-success btn-small"
                                            onClick={onAddWaitlistItem}
                                            style={{ marginLeft: '12px' }}
                                        >
                                            + Add
                                        </button>
                                    </td>
                                </tr>
                                {waitlist.map((item, idx) => (
                                    <tr key={item.id} className="waitlist-row">
                                        <td colspan="2"></td>
                                        <td>{idx + 1}</td>
                                        <td className="position-cell">
                                            <input
                                                type="text"
                                                className="position-input"
                                                value={item.name}
                                                onChange={(e) => onUpdateWaitlistItem(item.id, e.target.value, item.isNew)}
                                                placeholder="Type name..."
                                            />
                                        </td>
                                        <td className="checkbox-cell">
                                            <input
                                                type="checkbox"
                                                checked={item.isNew}
                                                onChange={(e) => onUpdateWaitlistItem(item.id, item.name, e.target.checked)}
                                            />
                                            <button
                                                className="btn btn-danger btn-small"
                                                onClick={() => onRemoveWaitlistItem(item.id)}
                                                style={{ marginLeft: '4px' }}
                                            >
                                                ×
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </>
            );
        }

        function ReportingView({ onLoadShift }) {
            const [reports, setReports] = useState([]);
            const [selectedReport, setSelectedReport] = useState(null);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                loadReports();
            }, []);

            const loadReports = async () => {
                setLoading(true);
                const reportsList = [];

                // Load from Firebase if configured
                if (isFirebaseConfigured && db) {
                    try {
                        const snapshot = await db.collection('staffing').orderBy('date', 'desc').limit(50).get();
                        snapshot.forEach(doc => {
                            reportsList.push({ id: doc.id, ...doc.data() });
                        });
                    } catch (error) {
                        console.error('Error loading Firebase reports:', error);
                    }
                }

                // Also check localStorage
                const localKeys = Object.keys(localStorage)
                    .filter(key => key.startsWith('staffing_'))
                    .filter(key => !key.includes('coreAssociates'));

                localKeys.forEach(key => {
                    const data = storage.load(key);
                    if (data && !reportsList.find(r => r.id === `${data.date}_${data.shift}`)) {
                        reportsList.push({ id: `${data.date}_${data.shift}`, ...data });
                    }
                });

                // Sort by date and shift
                reportsList.sort((a, b) => {
                    if (a.date !== b.date) return b.date.localeCompare(a.date);
                    return a.shift.localeCompare(b.shift);
                });

                setReports(reportsList);
                setLoading(false);
            };

            const viewReport = (report) => {
                setSelectedReport(report);
            };

            const closeReport = () => {
                setSelectedReport(null);
            };

            const loadIntoStaffing = (report) => {
                onLoadShift(report.date, report.shift);
            };

            if (selectedReport) {
                const totalPositions = selectedReport.lines.reduce((sum, line) => sum + line.needed, 0);
                const filledPositions = selectedReport.lines.reduce((sum, line) =>
                    sum + line.positions.filter(p => p.name && p.name.trim()).length, 0
                );

                return (
                    <div>
                        <button className="btn btn-secondary" onClick={closeReport} style={{ marginBottom: '16px' }}>
                            ← Back to Reports
                        </button>

                        <div className="shift-info">
                            <div>
                                <strong>Date:</strong> {selectedReport.date}
                            </div>
                            <div>
                                <strong>Shift:</strong> {selectedReport.shift}
                            </div>
                            <div>
                                <strong>Filled:</strong> {filledPositions} / {totalPositions}
                            </div>
                            <button
                                className="btn btn-primary"
                                onClick={() => loadIntoStaffing(selectedReport)}
                                style={{ marginLeft: 'auto' }}
                            >
                                Load into Staffing
                            </button>
                        </div>

                        <div style={{ overflowX: 'auto', marginTop: '16px' }}>
                            <table className="staffing-table">
                                <thead>
                                    <tr>
                                        <th>Line</th>
                                        <th>Lead</th>
                                        <th>Pos</th>
                                        <th>Associate Name</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {selectedReport.lines.map(line => (
                                        line.positions.map((position, idx) => (
                                            <tr key={idx}>
                                                {idx === 0 && (
                                                    <>
                                                        <td className="line-cell" rowSpan={line.needed}>
                                                            {line.letter}
                                                        </td>
                                                        <td className="lead-cell" rowSpan={line.needed}>
                                                            {line.lead}
                                                        </td>
                                                    </>
                                                )}
                                                <td>{idx + 1}</td>
                                                <td>{position.name || <em style={{ color: '#9ca3af' }}>Empty</em>}</td>
                                                <td>
                                                    {position.isNew && <span className="badge badge-new">NEW</span>}
                                                </td>
                                            </tr>
                                        ))
                                    ))}

                                    {selectedReport.waitlist && selectedReport.waitlist.length > 0 && (
                                        <>
                                            <tr>
                                                <td colspan="5" style={{ height: '8px', background: '#f9fafb' }}></td>
                                            </tr>
                                            <tr style={{ background: '#fffbeb' }}>
                                                <td colspan="5" style={{ fontWeight: '600', padding: '8px' }}>
                                                    WAITLIST ({selectedReport.waitlist.length})
                                                </td>
                                            </tr>
                                            {selectedReport.waitlist.map((item, idx) => (
                                                <tr key={idx} className="waitlist-row">
                                                    <td colspan="2"></td>
                                                    <td>{idx + 1}</td>
                                                    <td>{item.name}</td>
                                                    <td>
                                                        {item.isNew && <span className="badge badge-new">NEW</span>}
                                                    </td>
                                                </tr>
                                            ))}
                                        </>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="report-controls">
                        <h3 style={{ marginBottom: '8px' }}>Saved Staffing Reports</h3>
                        <p style={{ fontSize: '12px', color: '#6b7280' }}>
                            View and load previous staffing sheets
                        </p>
                    </div>

                    {loading ? (
                        <div className="empty-state">
                            <p>Loading reports...</p>
                        </div>
                    ) : reports.length === 0 ? (
                        <div className="empty-state">
                            <h3>No Reports Available</h3>
                            <p>Staffing sheets will appear here after you save them.</p>
                        </div>
                    ) : (
                        <div className="report-list">
                            {reports.map(report => {
                                const totalPositions = report.lines.reduce((sum, line) => sum + line.needed, 0);
                                const filledPositions = report.lines.reduce((sum, line) =>
                                    sum + line.positions.filter(p => p.name && p.name.trim()).length, 0
                                );

                                return (
                                    <div
                                        key={report.id}
                                        className="report-item"
                                        onClick={() => viewReport(report)}
                                    >
                                        <h4>{report.date} - {report.shift} Shift</h4>
                                        <p>
                                            {filledPositions} / {totalPositions} positions filled
                                            {report.waitlist && report.waitlist.length > 0 && ` • ${report.waitlist.length} waiting`}
                                        </p>
                                        {report.lastUpdated && (
                                            <p style={{ fontSize: '11px', marginTop: '4px' }}>
                                                Last updated: {new Date(report.lastUpdated).toLocaleString()}
                                            </p>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        function SetupView({ onSetupShift, coreAssociates }) {
            const [lines, setLines] = useState([{ letter: '', lead: '', needed: '' }]);

            const handleAddLine = () => {
                setLines([...lines, { letter: '', lead: '', needed: '' }]);
            };

            const handleRemoveLine = (index) => {
                setLines(lines.filter((_, i) => i !== index));
            };

            const handleLineChange = (index, field, value) => {
                const newLines = [...lines];
                newLines[index][field] = value;
                setLines(newLines);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const validLines = lines.filter(l => l.letter && l.lead && l.needed);
                if (validLines.length > 0) {
                    onSetupShift({ lines: validLines });
                } else {
                    alert('Please fill in all fields for at least one line.');
                }
            };

            const allLeads = Object.keys(coreAssociates);

            return (
                <form onSubmit={handleSubmit} className="setup-form">
                    <div className="form-section">
                        <h3>Configure Production Lines</h3>
                        {lines.map((line, index) => (
                            <div key={index} className="form-grid" style={{ marginBottom: '12px', padding: '12px', background: 'white', borderRadius: '6px' }}>
                                <div className="form-group">
                                    <label>Line Letter *</label>
                                    <input
                                        type="text"
                                        value={line.letter}
                                        onChange={(e) => handleLineChange(index, 'letter', e.target.value.toUpperCase())}
                                        placeholder="A, B, C..."
                                        required
                                        maxLength="2"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Line Lead *</label>
                                    <input
                                        type="text"
                                        list="leads"
                                        value={line.lead}
                                        onChange={(e) => handleLineChange(index, 'lead', e.target.value)}
                                        placeholder="Lead name"
                                        required
                                    />
                                    <datalist id="leads">
                                        {allLeads.map(lead => (
                                            <option key={lead} value={lead} />
                                        ))}
                                    </datalist>
                                </div>
                                <div className="form-group">
                                    <label>Associates Needed *</label>
                                    <input
                                        type="number"
                                        value={line.needed}
                                        onChange={(e) => handleLineChange(index, 'needed', e.target.value)}
                                        placeholder="Number"
                                        required
                                        min="1"
                                        max="50"
                                    />
                                </div>
                                {lines.length > 1 && (
                                    <div style={{ display: 'flex', alignItems: 'flex-end' }}>
                                        <button
                                            type="button"
                                            className="btn btn-danger btn-small"
                                            onClick={() => handleRemoveLine(index)}
                                        >
                                            Remove
                                        </button>
                                    </div>
                                )}
                            </div>
                        ))}
                        <button type="button" className="btn btn-secondary" onClick={handleAddLine}>
                            + Add Another Line
                        </button>
                    </div>

                    <button type="submit" className="btn btn-success" style={{ fontSize: '14px', padding: '10px 20px' }}>
                        Start Staffing
                    </button>
                </form>
            );
        }

        function CoreAssociatesView({ coreAssociates, onAddCoreAssociate, onRemoveCoreAssociate }) {
            const [selectedLead, setSelectedLead] = useState('');
            const [newLead, setNewLead] = useState('');
            const [newName, setNewName] = useState('');
            const [newNotes, setNewNotes] = useState('');

            const allLeads = Object.keys(coreAssociates);
            const currentLead = selectedLead || newLead;
            const currentAssociates = coreAssociates[currentLead] || [];

            const handleAddAssociate = (e) => {
                e.preventDefault();
                if (currentLead && newName) {
                    onAddCoreAssociate(currentLead, {
                        name: newName,
                        notes: newNotes
                    });
                    setNewName('');
                    setNewNotes('');
                    if (newLead) {
                        setSelectedLead(newLead);
                        setNewLead('');
                    }
                }
            };

            return (
                <div className="setup-form">
                    <div className="form-section">
                        <h3>Manage Core Associates</h3>
                        <p style={{ color: '#6b7280', marginBottom: '12px', fontSize: '12px' }}>
                            Core associates are team members assigned to specific line leads.
                        </p>

                        <div className="form-grid">
                            <div className="form-group">
                                <label>Select Existing Lead</label>
                                <select
                                    value={selectedLead}
                                    onChange={(e) => {
                                        setSelectedLead(e.target.value);
                                        setNewLead('');
                                    }}
                                >
                                    <option value="">-- Select Lead --</option>
                                    {allLeads.map(lead => (
                                        <option key={lead} value={lead}>{lead}</option>
                                    ))}
                                </select>
                            </div>
                            <div style={{ textAlign: 'center', padding: '16px 0', color: '#6b7280' }}>OR</div>
                            <div className="form-group">
                                <label>New Lead Name</label>
                                <input
                                    type="text"
                                    value={newLead}
                                    onChange={(e) => {
                                        setNewLead(e.target.value);
                                        setSelectedLead('');
                                    }}
                                    placeholder="Enter new lead name"
                                />
                            </div>
                        </div>

                        {currentLead && (
                            <div style={{ marginTop: '20px' }}>
                                <h4 style={{ marginBottom: '12px', fontSize: '14px' }}>Core Associates for {currentLead}</h4>

                                <form onSubmit={handleAddAssociate}>
                                    <div className="form-grid">
                                        <div className="form-group">
                                            <label>Associate Name *</label>
                                            <input
                                                type="text"
                                                value={newName}
                                                onChange={(e) => setNewName(e.target.value)}
                                                placeholder="Full name"
                                                required
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Notes (Optional)</label>
                                            <input
                                                type="text"
                                                value={newNotes}
                                                onChange={(e) => setNewNotes(e.target.value)}
                                                placeholder="e.g., Certified trainer"
                                            />
                                        </div>
                                    </div>
                                    <button type="submit" className="btn btn-success">
                                        + Add Core Associate
                                    </button>
                                </form>

                                <div className="core-associates-list">
                                    {currentAssociates.length === 0 ? (
                                        <p style={{ color: '#6b7280', fontStyle: 'italic', fontSize: '12px' }}>
                                            No core associates yet for this lead.
                                        </p>
                                    ) : (
                                        currentAssociates.map((associate, index) => (
                                            <div key={index} className="core-associate-item">
                                                <div className="core-associate-info">
                                                    <div className="core-associate-name">{associate.name}</div>
                                                    {associate.notes && (
                                                        <div className="core-associate-notes">{associate.notes}</div>
                                                    )}
                                                </div>
                                                <button
                                                    className="btn btn-danger btn-small"
                                                    onClick={() => onRemoveCoreAssociate(currentLead, index)}
                                                >
                                                    Remove
                                                </button>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
