<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crescent Staffing Planner</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <!-- SheetJS for XLSX export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 8px;
            font-size: 13px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-primary:hover {
            background: #f5f7ff;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }

        .firebase-status {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            z-index: 100;
        }

        .firebase-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .firebase-status-dot.connected {
            background: #10b981;
            box-shadow: 0 0 4px rgba(16, 185, 129, 0.5);
        }

        .firebase-status-dot.disconnected {
            background: #ef4444;
            box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);
        }

        .firebase-status-dot.offline {
            background: #f59e0b;
            box-shadow: 0 0 4px rgba(245, 158, 11, 0.5);
        }

        .cloud-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .cloud-badge.synced {
            background: #d1fae5;
            color: #065f46;
        }

        .cloud-badge.local-only {
            background: #fee2e2;
            color: #991b1b;
        }

        .content {
            padding: 16px;
        }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 8px 16px;
            background: none;
            border: none;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        /* Staffing Layout - Vertical Columns */
        .staffing-layout {
            display: flex;
            gap: 10px;
            height: calc(100vh - 200px);
            overflow: hidden;
        }

        .lines-container {
            flex: 1;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 12px;
            padding-right: 4px;
            scroll-behavior: smooth;
        }

        /* Better scrollbar styling */
        .lines-container::-webkit-scrollbar {
            height: 10px;
        }

        .lines-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }

        .lines-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

        .lines-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .line-column {
            min-width: 160px;
            width: 200px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }

        .line-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            text-align: center;
            flex-shrink: 0;
        }

        .line-letter {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .line-lead {
            font-size: 11px;
            opacity: 0.95;
            line-height: 1.3;
            max-height: 40px;
            overflow-y: auto;
            overflow-x: hidden;
            word-wrap: break-word;
        }

        .line-stats {
            font-size: 10px;
            margin-top: 3px;
            opacity: 0.9;
        }

        .positions-list {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            scroll-behavior: smooth;
        }

        /* Better scrollbar for positions list */
        .positions-list::-webkit-scrollbar {
            width: 8px;
        }

        .positions-list::-webkit-scrollbar-track {
            background: #f9fafb;
        }

        .positions-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .positions-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .position-slot {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 6px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }

        .position-slot:hover {
            border-color: #9ca3af;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .position-slot.filled {
            background: #ecfdf5;
            border-color: #10b981;
        }

        .position-slot.new-associate {
            background: #fef9c3;
            border-color: #eab308;
        }

        .position-number {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            min-width: 18px;
            flex-shrink: 0;
            text-align: center;
        }

        .position-input {
            flex: 1;
            padding: 5px 6px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 12px;
            min-width: 0;
        }

        .position-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .position-checkbox {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .position-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Waitlist Sidebar */
        .waitlist-sidebar {
            width: 200px;
            display: flex;
            flex-direction: column;
            background: #fffbeb;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .waitlist-header {
            background: #fbbf24;
            color: #78350f;
            padding: 10px;
            text-align: center;
            font-weight: 700;
            font-size: 12px;
            flex-shrink: 0;
        }

        .waitlist-items {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            scroll-behavior: smooth;
        }

        /* Scrollbar for waitlist */
        .waitlist-items::-webkit-scrollbar {
            width: 8px;
        }

        .waitlist-items::-webkit-scrollbar-track {
            background: #fef9c3;
        }

        .waitlist-items::-webkit-scrollbar-thumb {
            background: #fbbf24;
            border-radius: 4px;
        }

        .waitlist-items::-webkit-scrollbar-thumb:hover {
            background: #f59e0b;
        }

        .waitlist-item {
            background: white;
            border: 1px solid #fbbf24;
            border-radius: 4px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .waitlist-input {
            width: 100%;
            padding: 5px 6px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 12px;
        }

        .waitlist-input:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.1);
        }

        .waitlist-controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        .badge-new {
            background: #dbeafe;
            color: #1e40af;
        }

        .stats-bar {
            background: #f9fafb;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .save-status {
            font-size: 11px;
            color: #10b981;
            font-weight: 600;
        }

        /* Setup Form */
        .setup-form {
            display: grid;
            gap: 16px;
        }

        .form-section {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .form-section h3 {
            font-size: 16px;
            color: #111827;
            margin-bottom: 12px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Reporting View */
        .report-controls {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .report-list {
            display: grid;
            gap: 12px;
        }

        .report-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .report-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .report-item h4 {
            font-size: 14px;
            color: #111827;
            margin-bottom: 4px;
        }

        .report-item p {
            font-size: 12px;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state h3 {
            font-size: 16px;
            color: #374151;
            margin-bottom: 8px;
        }

        .core-associates-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .core-associate-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .core-associate-info {
            flex: 1;
        }

        .core-associate-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 2px;
            font-size: 13px;
        }

        .core-associate-flags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        .flag-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        .flag-sitdown { background: #dbeafe; color: #1e40af; }
        .flag-sanitation { background: #fef3c7; color: #92400e; }
        .flag-office { background: #e9d5ff; color: #6b21a8; }
        .flag-high { background: #d1fae5; color: #065f46; }
        .flag-low { background: #fee2e2; color: #991b1b; }

        .flag-dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .flag-dropdown-button {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .flag-dropdown-button:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .flag-dropdown-button:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .flag-dropdown-content {
            position: absolute;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 8px;
            z-index: 1000;
            min-width: 180px;
            top: 100%;
            left: 0;
            margin-top: 4px;
        }

        .flag-option {
            padding: 6px 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }

        .flag-option:hover {
            background: #f3f4f6;
        }

        .flag-option input[type="checkbox"] {
            cursor: pointer;
        }

        .filter-controls {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
        }

        .filter-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
        }

        .line-edit-controls {
            display: flex;
            gap: 4px;
            margin-top: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .line-edit-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 3px;
            font-size: 11px;
            margin-top: 4px;
            background: rgba(255,255,255,0.9);
        }

        .line-column.cut {
            opacity: 0.6;
            border-color: #ef4444;
            background: #fee2e2;
        }

        .line-column.cut .line-header {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .cut-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #dc2626;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            z-index: 10;
        }

        .position-slot.dragging {
            opacity: 0.4;
        }

        .position-slot.drag-over {
            background: #e0e7ff;
            border-color: #667eea;
            border-width: 2px;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .waitlist-item.dragging {
            opacity: 0.4;
        }

        .waitlist-item.drag-over {
            background: #e0e7ff;
            border-color: #667eea;
        }

        .drag-preview {
            position: absolute;
            background: white;
            border: 2px solid #667eea;
            border-radius: 4px;
            padding: 4px 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0.9;
            pointer-events: none;
            z-index: 9999;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            font-size: 12px;
            width: 180px;
        }

        .quick-add-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .quick-add-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .quick-add-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .quick-add-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }

        .quick-add-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .quick-add-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .quick-add-hint {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 16px;
        }

        .quick-add-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 16px;
        }

        .quick-add-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f9fafb;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .quick-add-item:last-child {
            margin-bottom: 0;
        }

        .search-box {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .lead-section {
            margin-bottom: 24px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .lead-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }

        .view-mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
        }

        .view-mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .view-mode-btn:hover:not(.active) {
            border-color: #667eea;
            color: #667eea;
        }

        .firebase-config {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .firebase-config h4 {
            color: #92400e;
            margin-bottom: 8px;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .staffing-layout {
                flex-direction: column;
                height: auto;
            }

            .lines-container {
                flex-direction: column;
                overflow-x: hidden;
                overflow-y: auto;
            }

            .line-column {
                max-width: 100%;
            }

            .waitlist-sidebar {
                width: 100%;
            }
        }

        @media print {
            body { padding: 0; background: white; font-size: 11px; }
            .header, .tabs, .firebase-status, .undo-banner, .bulk-action-bar,
            .duplicate-warning button, .line-edit-controls, .lock-banner button { display: none !important; }
            .container { box-shadow: none; border-radius: 0; }
            .content { padding: 8px; }
            .stats-bar { border: 1px solid #ccc; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            .stats-bar button, .stats-bar .save-status, .stats-bar .save-error { display: none !important; }
            .staffing-layout { height: auto !important; overflow: visible !important; }
            .lines-container { overflow: visible !important; flex-wrap: wrap; }
            .line-column { break-inside: avoid; border: 1px solid #333; min-width: 140px; }
            .waitlist-sidebar { break-inside: avoid; border: 1px solid #333; }
            .position-input { border: none !important; box-shadow: none !important; padding: 2px !important; }
            .waitlist-input { border: none !important; box-shadow: none !important; padding: 2px !important; }
            .waitlist-controls button { display: none !important; }
            .print-header { display: block !important; text-align: center; font-size: 16px; font-weight: bold; margin-bottom: 8px; }
        }
        .print-header { display: none; }

        .undo-banner {
            position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%);
            background: #1f2937; color: white; padding: 12px 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center;
            gap: 16px; z-index: 200; font-size: 13px; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .undo-banner button { background: #667eea; color: white; border: none; padding: 6px 14px; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 12px; }

        .lock-banner {
            background: #fef3c7; border: 2px solid #f59e0b; border-radius: 6px;
            padding: 10px 16px; margin-bottom: 12px; display: flex; justify-content: space-between;
            align-items: center; font-size: 13px; font-weight: 600; color: #92400e;
        }
        .locked-overlay { pointer-events: none; opacity: 0.6; user-select: none; }

        .duplicate-warning {
            background: #fff7ed; border: 1px solid #f97316; border-radius: 6px;
            padding: 8px 12px; margin-bottom: 8px; font-size: 12px; color: #9a3412;
        }

        .bulk-action-bar {
            position: fixed; bottom: 0; left: 0; right: 0; background: #1f2937; color: white;
            padding: 12px 20px; display: flex; align-items: center; justify-content: center;
            gap: 12px; z-index: 150; box-shadow: 0 -4px 12px rgba(0,0,0,0.2); font-size: 13px;
        }
        .bulk-action-bar button { padding: 6px 14px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 12px; }
        .bulk-checkbox { position: absolute; top: 2px; left: 2px; z-index: 5; }

        .save-error {
            color: #ef4444; font-weight: 600; display: flex; align-items: center; gap: 6px; font-size: 11px;
        }
        .save-error button { background: none; border: none; color: #ef4444; font-weight: bold; cursor: pointer; font-size: 14px; }

        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .analytics-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px; }
        .analytics-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; text-align: center; }
        .analytics-card h4 { font-size: 28px; font-weight: 700; color: #667eea; margin-bottom: 4px; }
        .analytics-card p { font-size: 12px; color: #6b7280; }
        .bar-chart { margin-bottom: 8px; }
        .bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 12px; }
        .bar-label { min-width: 80px; text-align: right; font-weight: 600; color: #374151; flex-shrink: 0; }
        .bar-fill { height: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; transition: width 0.3s; min-width: 2px; color: white; font-size: 11px; font-weight: 600; display: flex; align-items: center; padding: 0 8px; }

        .comparison-container { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .comparison-side { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
        .comparison-side h4 { background: #f3f4f6; padding: 10px 12px; font-size: 13px; border-bottom: 1px solid #e5e7eb; }
        .comparison-line { padding: 8px 12px; border-bottom: 1px solid #f3f4f6; }
        .comparison-name { padding: 2px 6px; border-radius: 3px; font-size: 12px; margin: 1px 0; display: block; }
        .comparison-name.added { background: #d1fae5; color: #065f46; }
        .comparison-name.removed { background: #fee2e2; color: #991b1b; }
        .comparison-name.same { background: #f3f4f6; color: #374151; }
        .comparison-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
        .comparison-stat { text-align: center; padding: 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase configuration
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyD2ySRicFt2-Zd2JRaW0ZHHb97gzwgcdWg",
            authDomain: "staffingtool-1ab4f.firebaseapp.com",
            databaseURL: "https://staffingtool-1ab4f-default-rtdb.firebaseio.com",
            projectId: "staffingtool-1ab4f",
            storageBucket: "staffingtool-1ab4f.firebasestorage.app",
            messagingSenderId: "956290053379",
            appId: "1:956290053379:web:2611b6db69ef2c9b2de536",
            measurementId: "G-HFR8KR0HMQ"
        };

        let db = null;
        let isFirebaseConfigured = false;

        // Check if Firebase is configured
        try {
            const configuredKeys = Object.values(FIREBASE_CONFIG).filter(v => !v.startsWith('YOUR_'));
            if (configuredKeys.length === Object.keys(FIREBASE_CONFIG).length) {
                firebase.initializeApp(FIREBASE_CONFIG);
                db = firebase.database();  // Using Realtime Database instead of Firestore
                isFirebaseConfigured = true;
                console.log('Firebase Realtime Database initialized successfully');
            } else {
                console.warn('Firebase not configured. Using localStorage only.');
            }
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Storage utilities
        const storage = {
            save: (key, data) => {
                try { localStorage.setItem(key, JSON.stringify(data)); }
                catch (e) { console.error('localStorage save failed (quota?):', e); }
            },
            load: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) { console.error('localStorage load failed:', e); return defaultValue; }
            },
            remove: (key) => { try { localStorage.removeItem(key); } catch(e) {} }
        };

        function App() {
            const [activeTab, setActiveTab] = useState('setup');
            const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
            const [currentShift, setCurrentShift] = useState('1st');
            const [lines, setLines] = useState([]);
            const [waitlist, setWaitlist] = useState([]);
            const [coreAssociates, setCoreAssociates] = useState({});
            const [lineLeadNotes, setLineLeadNotes] = useState({});
            const [saveStatus, setSaveStatus] = useState('');
            const [firebaseStatus, setFirebaseStatus] = useState(isFirebaseConfigured ? 'connected' : 'offline');
            const [isLocked, setIsLocked] = useState(false);
            const [undoStack, setUndoStack] = useState([]);
            const [undoMessage, setUndoMessage] = useState('');
            const saveTimeoutRef = useRef(null);
            const savingRef = useRef(false);
            const undoTimerRef = useRef(null);

            // Load core associates from Firebase and localStorage
            useEffect(() => {
                const loadCoreAssociates = async () => {
                    // Try Firebase first
                    if (isFirebaseConfigured && db) {
                        try {
                            const snapshot = await db.ref('settings/coreAssociates').once('value');
                            if (snapshot.exists()) {
                                const data = snapshot.val();
                                console.log('Loaded core associates from Firebase Realtime Database');
                                setCoreAssociates(data.associates || {});
                                setLineLeadNotes(data.notes || {});
                                return;
                            }
                        } catch (error) {
                            console.error('Error loading core associates from Firebase:', error);
                        }
                    }

                    // Fallback to localStorage
                    const savedCoreAssociates = storage.load('coreAssociates', {});
                    setCoreAssociates(savedCoreAssociates);
                    const savedNotes = storage.load('lineLeadNotes', {});
                    setLineLeadNotes(savedNotes);
                };
                loadCoreAssociates();
            }, []);

            // Save core associates and notes to both localStorage and Firebase
            useEffect(() => {
                storage.save('coreAssociates', coreAssociates);
                storage.save('lineLeadNotes', lineLeadNotes);

                // Also save to Firebase
                if (isFirebaseConfigured && db && Object.keys(coreAssociates).length > 0) {
                    db.ref('settings/coreAssociates').set({
                        associates: coreAssociates,
                        notes: lineLeadNotes,
                        lastUpdated: new Date().toISOString()
                    }).then(() => {
                        console.log('Core associates saved to Firebase Realtime Database');
                    }).catch(error => {
                        console.error('Error saving core associates to Firebase:', error);
                    });
                }
            }, [coreAssociates, lineLeadNotes]);

            // Auto-save functionality
            useEffect(() => {
                if (lines.length === 0) return;

                if (saveTimeoutRef.current) {
                    clearTimeout(saveTimeoutRef.current);
                }

                // Capture current values in closure to prevent stale data
                const capturedDate = currentDate;
                const capturedShift = currentShift;
                const capturedLines = lines;
                const capturedWaitlist = waitlist;
                const capturedLocked = isLocked;

                saveTimeoutRef.current = setTimeout(() => {
                    handleAutoSave(capturedDate, capturedShift, capturedLines, capturedWaitlist, capturedLocked);
                }, 2000);

                return () => {
                    if (saveTimeoutRef.current) {
                        clearTimeout(saveTimeoutRef.current);
                    }
                };
            }, [lines, waitlist, currentDate, currentShift]);

            const handleAutoSave = async (date, shift, saveLines, saveWaitlist, locked) => {
                if (savingRef.current) return;
                savingRef.current = true;

                const staffingData = {
                    date: date,
                    shift: shift,
                    lines: saveLines,
                    waitlist: saveWaitlist,
                    locked: locked,
                    lastUpdated: new Date().toISOString()
                };

                // Save to Firebase first if configured
                if (isFirebaseConfigured && db) {
                    try {
                        const docId = `${date}_${shift}`;
                        await db.ref('staffing/' + docId).set(staffingData);
                        storage.save(`staffing_${date}_${shift}`, staffingData);
                        setSaveStatus('Saved to cloud ✓');
                        setFirebaseStatus('connected');
                        setTimeout(() => setSaveStatus(''), 3000);
                    } catch (error) {
                        console.error('Firebase save error:', error);
                        setFirebaseStatus('disconnected');
                        // Still save locally as fallback
                        storage.save(`staffing_${date}_${shift}`, staffingData);
                        setSaveStatus('Error: Cloud save failed - saved locally only');
                        // Don't auto-clear errors
                    }
                } else {
                    storage.save(`staffing_${date}_${shift}`, staffingData);
                    setSaveStatus('Saved locally');
                    setTimeout(() => setSaveStatus(''), 3000);
                }

                savingRef.current = false;
            };

            const loadStaffingData = async (date, shift) => {
                console.log('Loading staffing data for:', date, shift);

                // Try Firebase first
                if (isFirebaseConfigured && db) {
                    try {
                        const docId = `${date}_${shift}`;
                        const snapshot = await db.ref('staffing/' + docId).once('value');
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            console.log('Loaded from Firebase Realtime Database:', docId, data);
                            setLines(data.lines || []);
                            setWaitlist(data.waitlist || []);
                            setIsLocked(data.locked || false);
                            return;
                        } else {
                            console.log('Document not found in Firebase:', docId);
                        }
                    } catch (error) {
                        console.error('Firebase load error:', error);
                        alert('Error loading from Firebase: ' + error.message);
                    }
                }

                // Fallback to localStorage
                const localData = storage.load(`staffing_${date}_${shift}`, null);
                if (localData) {
                    console.log('Loaded from localStorage:', localData);
                    setLines(localData.lines || []);
                    setWaitlist(localData.waitlist || []);
                    setIsLocked(localData.locked || false);
                } else {
                    console.log('No data found');
                    setLines([]);
                    setWaitlist([]);
                    setIsLocked(false);
                }
            };

            const handleSetupShift = (shiftData) => {
                setCurrentDate(shiftData.date);
                setCurrentShift(shiftData.shift);

                // If loading existing sheet, just load the data
                if (shiftData.loadExisting) {
                    loadStaffingData(shiftData.date, shiftData.shift);
                    setActiveTab('staffing');
                    return;
                }

                const newLines = shiftData.lines.map(line => {
                    // Support both old (single lead) and new (multiple leads) format
                    const leads = line.leads || (line.lead ? [line.lead] : []);

                    // Combine core associates from all leads
                    const allCoreAssociates = [];
                    leads.forEach(lead => {
                        // Try exact match first, then case-insensitive match
                        let coreList = coreAssociates[lead];
                        if (!coreList) {
                            const matchKey = Object.keys(coreAssociates).find(
                                k => k.toLowerCase() === lead.toLowerCase()
                            );
                            coreList = matchKey ? coreAssociates[matchKey] : [];
                        }
                        allCoreAssociates.push(...coreList);
                    });

                    return {
                        id: Date.now() + Math.random(),
                        letter: line.letter,
                        leads: leads,
                        needed: parseInt(line.needed),
                        isCut: false,
                        positions: Array(parseInt(line.needed)).fill(null).map((_, idx) => {
                            // Pre-fill with core associates from all leads
                            if (idx < allCoreAssociates.length) {
                                return {
                                    id: Date.now() + Math.random() + idx,
                                    name: allCoreAssociates[idx].name,
                                    isNew: false
                                };
                            }
                            return {
                                id: Date.now() + Math.random() + idx,
                                name: '',
                                isNew: false
                            };
                        })
                    };
                });

                setLines(newLines);
                setWaitlist([]);
                setActiveTab('staffing');
            };

            const handleUpdatePosition = (lineId, positionId, name, isNew) => {
                setLines(prev => prev.map(line => {
                    if (line.id === lineId) {
                        return {
                            ...line,
                            positions: line.positions.map(pos =>
                                pos.id === positionId
                                    ? { ...pos, name: name, isNew }
                                    : pos
                            )
                        };
                    }
                    return line;
                }));
            };

            const handleUpdateWaitlistItem = (itemId, name, isNew) => {
                setWaitlist(prev => prev.map(item =>
                    item.id === itemId ? { ...item, name: name, isNew } : item
                ));
            };

            const handleAddWaitlistItem = () => {
                setWaitlist(prev => [...prev, {
                    id: Date.now() + Math.random(),
                    name: '',
                    isNew: false
                }]);
            };

            const handleQuickAddWaitlist = (names) => {
                const newItems = names.map(name => ({
                    id: Date.now() + Math.random(),
                    name: name,
                    isNew: false
                }));
                setWaitlist(prev => [...prev, ...newItems]);
            };

            const handleRemoveWaitlistItem = (itemId) => {
                setWaitlist(prev => prev.filter(item => item.id !== itemId));
            };

            const handleAddLine = () => {
                const newLine = {
                    id: Date.now() + Math.random(),
                    letter: '',
                    leads: [],
                    needed: 5,
                    isCut: false,
                    positions: Array(5).fill(null).map((_, idx) => ({
                        id: Date.now() + Math.random() + idx,
                        name: '',
                        isNew: false
                    }))
                };
                setLines(prev => [...prev, newLine]);
            };

            const handleToggleCutLine = (lineId) => {
                const targetLine = lines.find(l => l.id === lineId);
                if (targetLine && !targetLine.isCut) {
                    pushUndo(`Line ${targetLine.letter || '?'} cut`);
                }
                setLines(prev => prev.map(line => {
                    if (line.id === lineId) {
                        const newCutStatus = !line.isCut;

                        // If marking as cut, move all assigned associates to waitlist
                        if (newCutStatus) {
                            const assignedAssociates = line.positions
                                .filter(p => p.name.trim())
                                .map(p => ({
                                    id: Date.now() + Math.random(),
                                    name: p.name,
                                    isNew: p.isNew
                                }));

                            if (assignedAssociates.length > 0) {
                                setWaitlist(prev => [...prev, ...assignedAssociates]);
                            }

                            // Clear all positions
                            return {
                                ...line,
                                isCut: true,
                                positions: line.positions.map(p => ({ ...p, name: '', isNew: false }))
                            };
                        }

                        return { ...line, isCut: newCutStatus };
                    }
                    return line;
                }));
            };

            const handleDragStart = (e, source) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('application/json', JSON.stringify(source));

                // Create custom drag preview
                const dragPreview = document.createElement('div');
                dragPreview.className = 'drag-preview';

                // Get the name being dragged
                let dragName = '';
                if (source.type === 'waitlist') {
                    const item = waitlist.find(w => w.id === source.id);
                    dragName = item?.name || '';
                } else if (source.type === 'position') {
                    const line = lines.find(l => l.id === source.lineId);
                    const position = line?.positions.find(p => p.id === source.positionId);
                    dragName = position?.name || '';
                }

                dragPreview.innerHTML = `
                    <div style="min-width: 18px; font-size: 11px; font-weight: 600; color: #6b7280; text-align: center;">⋮⋮</div>
                    <div style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${dragName}</div>
                `;
                dragPreview.style.left = '-9999px';
                document.body.appendChild(dragPreview);
                e.dataTransfer.setDragImage(dragPreview, 0, 0);
                setTimeout(() => document.body.removeChild(dragPreview), 0);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, target) => {
                e.preventDefault();
                let source;
                try {
                    source = JSON.parse(e.dataTransfer.getData('application/json'));
                } catch (err) {
                    console.error('Invalid drag data:', err);
                    return;
                }

                // Don't allow drops on cut lines
                if (target.type === 'position') {
                    const targetLine = lines.find(l => l.id === target.lineId);
                    if (targetLine && targetLine.isCut) {
                        return;
                    }
                }

                // Handle different drop scenarios
                if (source.type === 'waitlist' && target.type === 'position') {
                    // Move from waitlist to position
                    const waitlistItem = waitlist.find(w => w.id === source.id);
                    const targetLine = lines.find(l => l.id === target.lineId);
                    const targetPosition = targetLine?.positions.find(p => p.id === target.positionId);

                    if (waitlistItem && targetPosition) {
                        // If target position is filled, move that person to waitlist first
                        if (targetPosition.name.trim()) {
                            setWaitlist(prev => [
                                ...prev.filter(w => w.id !== source.id),
                                {
                                    id: Date.now() + Math.random(),
                                    name: targetPosition.name,
                                    isNew: targetPosition.isNew
                                }
                            ]);
                        } else {
                            // Just remove from waitlist
                            handleRemoveWaitlistItem(source.id);
                        }
                        // Assign waitlist person to position
                        handleUpdatePosition(target.lineId, target.positionId, waitlistItem.name, waitlistItem.isNew);
                    }
                } else if (source.type === 'position' && target.type === 'waitlist') {
                    // Move from position to waitlist
                    const sourceLine = lines.find(l => l.id === source.lineId);
                    const sourcePosition = sourceLine?.positions.find(p => p.id === source.positionId);
                    if (sourcePosition && sourcePosition.name.trim()) {
                        setWaitlist(prev => [...prev, {
                            id: Date.now() + Math.random(),
                            name: sourcePosition.name,
                            isNew: sourcePosition.isNew
                        }]);
                        handleUpdatePosition(source.lineId, source.positionId, '', false);
                    }
                } else if (source.type === 'position' && target.type === 'position') {
                    // Swap positions - use a single state update to avoid race conditions
                    setLines(prev => prev.map(line => {
                        if (line.id === source.lineId || line.id === target.lineId) {
                            return {
                                ...line,
                                positions: line.positions.map(pos => {
                                    if (line.id === source.lineId && pos.id === source.positionId) {
                                        // Replace source with target
                                        const targetLine = prev.find(l => l.id === target.lineId);
                                        const targetPos = targetLine?.positions.find(p => p.id === target.positionId);
                                        return targetPos ? { ...pos, name: targetPos.name, isNew: targetPos.isNew } : pos;
                                    } else if (line.id === target.lineId && pos.id === target.positionId) {
                                        // Replace target with source
                                        const sourceLine = prev.find(l => l.id === source.lineId);
                                        const sourcePos = sourceLine?.positions.find(p => p.id === source.positionId);
                                        return sourcePos ? { ...pos, name: sourcePos.name, isNew: sourcePos.isNew } : pos;
                                    }
                                    return pos;
                                })
                            };
                        }
                        return line;
                    }));
                }
            };

            const pushUndo = (msg) => {
                setUndoStack(prev => [...prev.slice(-4), { lines: JSON.parse(JSON.stringify(lines)), waitlist: JSON.parse(JSON.stringify(waitlist)) }]);
                setUndoMessage(msg);
                if (undoTimerRef.current) clearTimeout(undoTimerRef.current);
                undoTimerRef.current = setTimeout(() => setUndoMessage(''), 8000);
            };

            const handleUndo = () => {
                if (undoStack.length === 0) return;
                const last = undoStack[undoStack.length - 1];
                setLines(last.lines);
                setWaitlist(last.waitlist);
                setUndoStack(prev => prev.slice(0, -1));
                setUndoMessage('');
                if (undoTimerRef.current) clearTimeout(undoTimerRef.current);
            };

            const handleRemoveLine = (lineId) => {
                const line = lines.find(l => l.id === lineId);
                const desc = line ? `Line ${line.letter || '?'}` : 'Line';
                if (confirm(`Remove ${desc}?`)) {
                    pushUndo(`${desc} removed`);
                    setLines(prev => prev.filter(l => l.id !== lineId));
                }
            };

            const handleUpdateLine = (lineId, updates) => {
                // Check for truncation before entering state updater
                if (updates.needed !== undefined && !updates.positions) {
                    const currentLine = lines.find(l => l.id === lineId);
                    if (currentLine) {
                        const newNeeded = parseInt(updates.needed) || 0;
                        if (newNeeded < currentLine.positions.length) {
                            const wouldLose = currentLine.positions.slice(newNeeded).filter(p => p.name.trim());
                            if (wouldLose.length > 0) {
                                const names = wouldLose.map(p => p.name).join(', ');
                                if (!confirm(`Reducing positions will remove: ${names}\n\nContinue?`)) {
                                    return;
                                }
                            }
                        }
                    }
                }

                setLines(prev => prev.map(line => {
                    if (line.id === lineId) {
                        const updatedLine = { ...line, ...updates };

                        if (updates.positions) {
                            return updatedLine;
                        }

                        if (updates.needed !== undefined && updates.needed !== line.positions.length) {
                            const newNeeded = parseInt(updates.needed) || 0;
                            if (newNeeded > line.positions.length) {
                                const additionalPositions = Array(newNeeded - line.positions.length)
                                    .fill(null)
                                    .map((_, idx) => ({
                                        id: Date.now() + Math.random() + idx,
                                        name: '',
                                        isNew: false
                                    }));
                                updatedLine.positions = [...line.positions, ...additionalPositions];
                            } else {
                                updatedLine.positions = line.positions.slice(0, newNeeded);
                            }
                        }

                        return updatedLine;
                    }
                    return line;
                }));
            };

            const handleAddCoreAssociate = (lead, associate) => {
                setCoreAssociates(prev => ({
                    ...prev,
                    [lead]: [...(prev[lead] || []), associate]
                }));
            };

            const handleRemoveCoreAssociate = (lead, index) => {
                setCoreAssociates(prev => ({
                    ...prev,
                    [lead]: prev[lead].filter((_, i) => i !== index)
                }));
            };

            const handleUpdateCoreAssociate = (lead, index, updates) => {
                setCoreAssociates(prev => ({
                    ...prev,
                    [lead]: prev[lead].map((assoc, i) => i === index ? { ...assoc, ...updates } : assoc)
                }));
            };

            const handleDeleteLineLead = (lead) => {
                if (confirm(`Delete line lead "${lead}" and all associated core team members? This cannot be undone.`)) {
                    setCoreAssociates(prev => {
                        const updated = { ...prev };
                        delete updated[lead];
                        return updated;
                    });
                    setLineLeadNotes(prev => {
                        const updated = { ...prev };
                        delete updated[lead];
                        return updated;
                    });
                }
            };

            const handleRenameLineLead = (oldName, newName) => {
                if (!newName.trim() || newName === oldName) return;
                if (coreAssociates[newName]) {
                    alert(`A line lead named "${newName}" already exists.`);
                    return;
                }
                setCoreAssociates(prev => {
                    const updated = {};
                    Object.keys(prev).forEach(key => {
                        if (key === oldName) {
                            updated[newName] = prev[key];
                        } else {
                            updated[key] = prev[key];
                        }
                    });
                    return updated;
                });
                setLineLeadNotes(prev => {
                    const updated = {};
                    Object.keys(prev).forEach(key => {
                        if (key === oldName) {
                            updated[newName] = prev[key];
                        } else {
                            updated[key] = prev[key];
                        }
                    });
                    return updated;
                });
            };

            const handleUpdateLineLeadNotes = (lead, notes) => {
                setLineLeadNotes(prev => ({ ...prev, [lead]: notes }));
            };

            const handleExport = () => {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Calculate stats
                const activeLines = lines.filter(line => !line.isCut);
                const cutLines = lines.filter(line => line.isCut);
                const totalPositions = activeLines.reduce((sum, line) => sum + line.needed, 0);
                const filledPositions = activeLines.reduce((sum, line) =>
                    sum + line.positions.filter(p => p.name.trim()).length, 0
                );
                const newAssociates = activeLines.reduce((sum, line) =>
                    sum + line.positions.filter(p => p.name.trim() && p.isNew).length, 0
                );

                // Build data in column-based layout (like the tool)
                const data = [];

                // Title row
                data.push(['Crescent Staffing Planner']);

                // Info row
                data.push([`${currentDate} - ${currentShift} Shift`, '', '', '', `Exported: ${new Date().toLocaleString()}`]);

                // Stats row
                data.push([`${filledPositions} / ${totalPositions} filled`, `${newAssociates} new`, cutLines.length > 0 ? `${cutLines.length} cut` : '', waitlist.filter(w => w.name.trim()).length > 0 ? `${waitlist.filter(w => w.name.trim()).length} waiting` : '']);

                // Empty row
                data.push([]);

                // Find max positions needed for any line
                const maxPositions = Math.max(...lines.map(l => l.positions.length), waitlist.length);

                // Header row - Line letters and waitlist
                const headerRow = [];
                lines.forEach(line => {
                    headerRow.push(`Line ${line.letter}${line.isCut ? ' (CUT)' : ''}`);
                    headerRow.push(''); // Spacing column
                });
                headerRow.push('WAITLIST');
                data.push(headerRow);

                // Subheader row - Line leads
                const subheaderRow = [];
                lines.forEach(line => {
                    const leads = (line.leads || []).join(', ');
                    subheaderRow.push(leads || 'No lead');
                    subheaderRow.push(''); // Spacing column
                });
                subheaderRow.push('');
                data.push(subheaderRow);

                // Position rows
                for (let i = 0; i < maxPositions; i++) {
                    const row = [];
                    lines.forEach(line => {
                        const position = line.positions[i];
                        if (position) {
                            const name = position.name || '';
                            const marker = position.isNew ? ' ⭐' : '';
                            row.push(name + marker);
                        } else {
                            row.push('');
                        }
                        row.push(''); // Spacing column
                    });

                    // Add waitlist item
                    const waitlistItem = waitlist[i];
                    if (waitlistItem) {
                        const marker = waitlistItem.isNew ? ' ⭐' : '';
                        row.push((waitlistItem.name || '') + marker);
                    } else {
                        row.push('');
                    }

                    data.push(row);
                }

                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(data);

                // Set column widths
                const colWidths = [];
                lines.forEach(() => {
                    colWidths.push({ wch: 20 }); // Line column
                    colWidths.push({ wch: 2 });  // Spacing column
                });
                colWidths.push({ wch: 20 }); // Waitlist column
                ws['!cols'] = colWidths;

                // Apply styling
                const range = XLSX.utils.decode_range(ws['!ref']);

                // Style title (row 0)
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: C });
                    if (!ws[cellAddress]) continue;
                    ws[cellAddress].s = {
                        font: { bold: true, sz: 16, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "667EEA" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }

                // Style info row (row 1)
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 1, c: C });
                    if (!ws[cellAddress]) continue;
                    ws[cellAddress].s = {
                        font: { bold: true, sz: 11 },
                        fill: { fgColor: { rgb: "F3F4F6" } },
                        alignment: { horizontal: "center" }
                    };
                }

                // Style stats row (row 2)
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 2, c: C });
                    if (!ws[cellAddress]) continue;
                    ws[cellAddress].s = {
                        font: { sz: 10 },
                        fill: { fgColor: { rgb: "E5E7EB" } },
                        alignment: { horizontal: "center" }
                    };
                }

                // Style line headers (row 4)
                let colIndex = 0;
                lines.forEach((line, idx) => {
                    const cellAddress = XLSX.utils.encode_cell({ r: 4, c: colIndex });
                    if (ws[cellAddress]) {
                        ws[cellAddress].s = {
                            font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
                            fill: { fgColor: { rgb: line.isCut ? "EF4444" : "667EEA" } },
                            alignment: { horizontal: "center", vertical: "center" }
                        };
                    }
                    colIndex += 2; // Skip spacing column
                });

                // Style waitlist header
                const waitlistHeaderCell = XLSX.utils.encode_cell({ r: 4, c: colIndex });
                if (ws[waitlistHeaderCell]) {
                    ws[waitlistHeaderCell].s = {
                        font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "F59E0B" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }

                // Style lead names (row 5)
                colIndex = 0;
                lines.forEach(() => {
                    const cellAddress = XLSX.utils.encode_cell({ r: 5, c: colIndex });
                    if (ws[cellAddress]) {
                        ws[cellAddress].s = {
                            font: { italic: true, sz: 10 },
                            fill: { fgColor: { rgb: "F9FAFB" } },
                            alignment: { horizontal: "center" }
                        };
                    }
                    colIndex += 2;
                });

                // Style position cells (starting from row 6)
                for (let R = 6; R <= range.e.r; R++) {
                    colIndex = 0;
                    lines.forEach((line) => {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: colIndex });
                        if (ws[cellAddress]) {
                            const cellValue = ws[cellAddress].v || '';
                            const isNew = cellValue.includes('⭐');
                            const isEmpty = !cellValue.trim() || cellValue.trim() === '⭐';

                            ws[cellAddress].s = {
                                fill: {
                                    fgColor: {
                                        rgb: isEmpty ? "FFFFFF" :
                                             isNew ? "DBEAFE" :
                                             line.isCut ? "FEE2E2" :
                                             "F0FDF4"
                                    }
                                },
                                border: {
                                    top: { style: "thin", color: { rgb: "E5E7EB" } },
                                    bottom: { style: "thin", color: { rgb: "E5E7EB" } },
                                    left: { style: "thin", color: { rgb: "E5E7EB" } },
                                    right: { style: "thin", color: { rgb: "E5E7EB" } }
                                },
                                alignment: { vertical: "center" }
                            };
                        }
                        colIndex += 2;
                    });

                    // Style waitlist cells
                    const waitlistCell = XLSX.utils.encode_cell({ r: R, c: colIndex });
                    if (ws[waitlistCell]) {
                        const cellValue = ws[waitlistCell].v || '';
                        const isNew = cellValue.includes('⭐');
                        const isEmpty = !cellValue.trim() || cellValue.trim() === '⭐';

                        ws[waitlistCell].s = {
                            fill: {
                                fgColor: {
                                    rgb: isEmpty ? "FFFFFF" :
                                         isNew ? "DBEAFE" :
                                         "FEF3C7"
                                }
                            },
                            border: {
                                top: { style: "thin", color: { rgb: "E5E7EB" } },
                                bottom: { style: "thin", color: { rgb: "E5E7EB" } },
                                left: { style: "thin", color: { rgb: "E5E7EB" } },
                                right: { style: "thin", color: { rgb: "E5E7EB" } }
                            },
                            alignment: { vertical: "center" }
                        };
                    }
                }

                XLSX.utils.book_append_sheet(wb, ws, 'Staffing');

                // Export file
                XLSX.writeFile(wb, `staffing-${currentDate}-${currentShift}.xlsx`);
            };

            const handleClearAll = () => {
                if (confirm('Clear current shift data?')) {
                    pushUndo('Shift data cleared');
                    setLines([]);
                    setWaitlist([]);
                }
            };

            const handleToggleLock = () => {
                if (!isLocked) {
                    // Locking
                    if (confirm('Lock this staffing sheet? Once locked, no edits can be made until it is unlocked.')) {
                        setIsLocked(true);
                    }
                } else {
                    // Unlocking
                    if (confirm('Unlock this staffing sheet? This will allow edits to be made.')) {
                        setIsLocked(false);
                    }
                }
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>Crescent Staffing Planner</h1>
                        <div className="header-actions">
                            {lines.length > 0 && (
                                <>
                                    <button className="btn btn-secondary" onClick={() => window.print()}>
                                        Print
                                    </button>
                                    <button className="btn btn-secondary" onClick={handleExport}>
                                        Export
                                    </button>
                                    <button className="btn btn-danger" onClick={handleClearAll}>
                                        Clear
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    <div className="content">
                        <div className="tabs">
                            <button
                                className={`tab ${activeTab === 'setup' ? 'active' : ''}`}
                                onClick={() => setActiveTab('setup')}
                            >
                                Setup
                            </button>
                            <button
                                className={`tab ${activeTab === 'staffing' ? 'active' : ''}`}
                                onClick={() => setActiveTab('staffing')}
                            >
                                Staffing
                            </button>
                            <button
                                className={`tab ${activeTab === 'reporting' ? 'active' : ''}`}
                                onClick={() => setActiveTab('reporting')}
                            >
                                Reports
                            </button>
                            <button
                                className={`tab ${activeTab === 'core' ? 'active' : ''}`}
                                onClick={() => setActiveTab('core')}
                            >
                                Core Team
                            </button>
                            <button
                                className={`tab ${activeTab === 'analytics' ? 'active' : ''}`}
                                onClick={() => setActiveTab('analytics')}
                            >
                                Analytics
                            </button>
                        </div>

                        {activeTab === 'setup' && (
                            <SetupView
                                onSetupShift={handleSetupShift}
                                coreAssociates={coreAssociates}
                                initialDate={currentDate}
                                initialShift={currentShift}
                            />
                        )}

                        {activeTab === 'staffing' && (
                            <StaffingView
                                lines={lines}
                                waitlist={waitlist}
                                currentDate={currentDate}
                                currentShift={currentShift}
                                saveStatus={saveStatus}
                                setSaveStatus={setSaveStatus}
                                isLocked={isLocked}
                                coreAssociates={coreAssociates}
                                undoMessage={undoMessage}
                                onUndo={handleUndo}
                                onToggleLock={handleToggleLock}
                                onUpdatePosition={handleUpdatePosition}
                                onUpdateWaitlistItem={handleUpdateWaitlistItem}
                                onAddWaitlistItem={handleAddWaitlistItem}
                                onQuickAddWaitlist={handleQuickAddWaitlist}
                                onRemoveWaitlistItem={handleRemoveWaitlistItem}
                                onAddLine={handleAddLine}
                                onRemoveLine={handleRemoveLine}
                                onUpdateLine={handleUpdateLine}
                                onToggleCutLine={handleToggleCutLine}
                                onDragStart={handleDragStart}
                                onDragOver={handleDragOver}
                                onDrop={handleDrop}
                                setLines={setLines}
                                setWaitlist={setWaitlist}
                            />
                        )}

                        {activeTab === 'reporting' && (
                            <ReportingView
                                onLoadShift={(date, shift) => {
                                    setCurrentDate(date);
                                    setCurrentShift(shift);
                                    loadStaffingData(date, shift);
                                    setActiveTab('staffing');
                                }}
                            />
                        )}

                        {activeTab === 'analytics' && (
                            <AnalyticsView />
                        )}

                        {activeTab === 'core' && (
                            <CoreAssociatesView
                                coreAssociates={coreAssociates}
                                lineLeadNotes={lineLeadNotes}
                                onAddCoreAssociate={handleAddCoreAssociate}
                                onRemoveCoreAssociate={handleRemoveCoreAssociate}
                                onUpdateCoreAssociate={handleUpdateCoreAssociate}
                                onDeleteLineLead={handleDeleteLineLead}
                                onRenameLineLead={handleRenameLineLead}
                                onUpdateLineLeadNotes={handleUpdateLineLeadNotes}
                                firebaseStatus={firebaseStatus}
                            />
                        )}
                    </div>
                </div>
            );
        }

        function StaffingView({
            lines,
            waitlist,
            currentDate,
            currentShift,
            saveStatus,
            setSaveStatus,
            isLocked,
            coreAssociates,
            undoMessage,
            onUndo,
            onToggleLock,
            onUpdatePosition,
            onUpdateWaitlistItem,
            onAddWaitlistItem,
            onQuickAddWaitlist,
            onRemoveWaitlistItem,
            onAddLine,
            onRemoveLine,
            onUpdateLine,
            onToggleCutLine,
            onDragStart,
            onDragOver,
            onDrop,
            setLines,
            setWaitlist
        }) {
            const [isQuickAddOpen, setIsQuickAddOpen] = useState(false);
            const [quickAddInput, setQuickAddInput] = useState('');
            const [quickAddNames, setQuickAddNames] = useState([]);
            const [waitlistSearch, setWaitlistSearch] = useState('');
            const [selectMode, setSelectMode] = useState(false);
            const [selectedPositions, setSelectedPositions] = useState([]);
            const [selectedWaitlist, setSelectedWaitlist] = useState([]);
            const quickAddInputRef = useRef(null);

            useEffect(() => {
                if (isQuickAddOpen && quickAddInputRef.current) {
                    quickAddInputRef.current.focus();
                }
            }, [isQuickAddOpen]);

            const handleQuickAddKeyPress = (e) => {
                if (e.key === 'Enter' && quickAddInput.trim()) {
                    setQuickAddNames([...quickAddNames, quickAddInput.trim()]);
                    setQuickAddInput('');
                } else if (e.key === 'Escape') {
                    handleCancelQuickAdd();
                }
            };

            const handleRemoveQuickAddName = (index) => {
                setQuickAddNames(quickAddNames.filter((_, i) => i !== index));
            };

            const handleConfirmQuickAdd = () => {
                if (quickAddNames.length > 0) {
                    onQuickAddWaitlist(quickAddNames);
                }
                setIsQuickAddOpen(false);
                setQuickAddInput('');
                setQuickAddNames([]);
            };

            const handleCancelQuickAdd = () => {
                if (quickAddNames.length > 0) {
                    if (!confirm(`Discard ${quickAddNames.length} name(s)?`)) return;
                }
                setIsQuickAddOpen(false);
                setQuickAddInput('');
                setQuickAddNames([]);
            };

            if (lines.length === 0) {
                return (
                    <div className="empty-state">
                        <h3>No Shift Configured</h3>
                        <p>Go to "Setup" to create today's staffing chart.</p>
                    </div>
                );
            }

            // Calculate stats excluding cut lines
            const activeLines = lines.filter(line => !line.isCut);
            const cutLines = lines.filter(line => line.isCut);
            const totalPositions = activeLines.reduce((sum, line) => sum + line.needed, 0);
            const filledPositions = activeLines.reduce((sum, line) =>
                sum + line.positions.filter(p => p.name.trim()).length, 0
            );
            const newAssociates = activeLines.reduce((sum, line) =>
                sum + line.positions.filter(p => p.name.trim() && p.isNew).length, 0
            );

            // Duplicate person detection (bug #5)
            const allNames = [];
            lines.forEach(line => {
                if (!line.isCut) {
                    line.positions.forEach(p => {
                        if (p.name.trim()) allNames.push({ name: p.name.trim().toLowerCase(), location: `Line ${line.letter}` });
                    });
                }
            });
            waitlist.forEach(w => {
                if (w.name.trim()) allNames.push({ name: w.name.trim().toLowerCase(), location: 'Waitlist' });
            });
            const nameCounts = {};
            allNames.forEach(({ name, location }) => {
                if (!nameCounts[name]) nameCounts[name] = [];
                nameCounts[name].push(location);
            });
            const duplicates = Object.entries(nameCounts).filter(([_, locs]) => locs.length > 1);

            // Bulk operation handlers
            const togglePositionSelect = (lineId, positionId) => {
                setSelectedPositions(prev => {
                    const exists = prev.find(s => s.lineId === lineId && s.positionId === positionId);
                    if (exists) return prev.filter(s => !(s.lineId === lineId && s.positionId === positionId));
                    return [...prev, { lineId, positionId }];
                });
            };

            const toggleWaitlistSelect = (id) => {
                setSelectedWaitlist(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
            };

            const handleBulkMoveToWaitlist = () => {
                const toMove = [];
                selectedPositions.forEach(({ lineId, positionId }) => {
                    const line = lines.find(l => l.id === lineId);
                    if (line) {
                        const pos = line.positions.find(p => p.id === positionId);
                        if (pos && pos.name.trim()) {
                            toMove.push({ name: pos.name, isNew: pos.isNew });
                        }
                    }
                });
                if (toMove.length > 0) {
                    const newWaitlistItems = toMove.map(item => ({ id: Date.now() + Math.random(), name: item.name, isNew: item.isNew }));
                    setWaitlist(prev => [...prev, ...newWaitlistItems]);
                    setLines(prev => prev.map(line => ({
                        ...line,
                        positions: line.positions.map(pos => {
                            if (selectedPositions.find(s => s.lineId === line.id && s.positionId === pos.id)) {
                                return { ...pos, name: '', isNew: false };
                            }
                            return pos;
                        })
                    })));
                }
                setSelectedPositions([]);
                setSelectedWaitlist([]);
            };

            const handleBulkClear = () => {
                setLines(prev => prev.map(line => ({
                    ...line,
                    positions: line.positions.map(pos => {
                        if (selectedPositions.find(s => s.lineId === line.id && s.positionId === pos.id)) {
                            return { ...pos, name: '', isNew: false };
                        }
                        return pos;
                    })
                })));
                setWaitlist(prev => prev.map(item => {
                    if (selectedWaitlist.includes(item.id)) {
                        return { ...item, name: '', isNew: false };
                    }
                    return item;
                }));
                setSelectedPositions([]);
                setSelectedWaitlist([]);
            };

            const handleDeselectAll = () => {
                setSelectedPositions([]);
                setSelectedWaitlist([]);
            };

            const filteredWaitlist = waitlistSearch.trim()
                ? waitlist.filter(w => w.name.toLowerCase().includes(waitlistSearch.toLowerCase()))
                : waitlist;

            return (
                <>
                    <div className="print-header">Crescent Staffing Planner - {currentDate} - {currentShift} Shift</div>

                    {!isFirebaseConfigured && (
                        <div className="firebase-config">
                            <h4>⚠️ Firebase Not Configured</h4>
                            <p>Data is being saved locally only. To enable cloud sync and remote access, please configure Firebase in the code.</p>
                        </div>
                    )}

                    {isLocked && (
                        <div className="lock-banner">
                            <span>This staffing sheet is locked. Unlock to make changes.</span>
                            <button className="btn btn-primary btn-small" onClick={onToggleLock}>Unlock</button>
                        </div>
                    )}

                    {duplicates.length > 0 && (
                        <div className="duplicate-warning">
                            <strong>Duplicate names detected:</strong>{' '}
                            {duplicates.map(([name, locs]) => `${name} (${locs.join(', ')})`).join('; ')}
                        </div>
                    )}

                    <div className="stats-bar">
                        <div>
                            <strong>{currentDate}</strong> - {currentShift} Shift
                            {isLocked && (
                                <span style={{ marginLeft: '12px', padding: '4px 8px', background: '#fee2e2', color: '#991b1b', borderRadius: '4px', fontSize: '11px', fontWeight: '600' }}>
                                    🔒 LOCKED
                                </span>
                            )}
                        </div>
                        <div>
                            <strong style={{ color: '#10b981', fontSize: '14px' }}>{filledPositions}</strong> / {totalPositions} filled
                            {newAssociates > 0 && <span style={{ marginLeft: '12px', color: '#3b82f6' }}>• {newAssociates} new</span>}
                            {cutLines.length > 0 && <span style={{ marginLeft: '12px', color: '#ef4444' }}>• {cutLines.length} cut</span>}
                            {waitlist.filter(w => w.name.trim()).length > 0 && <span style={{ marginLeft: '12px', color: '#f59e0b' }}>• {waitlist.filter(w => w.name.trim()).length} waiting</span>}
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <button
                                className={`btn ${selectMode ? 'btn-primary' : 'btn-secondary'}`}
                                onClick={() => { setSelectMode(!selectMode); handleDeselectAll(); }}
                                disabled={isLocked}
                                style={{ fontSize: '12px', padding: '6px 12px', opacity: isLocked ? 0.5 : 1 }}
                            >
                                {selectMode ? 'Exit Select' : 'Select'}
                            </button>
                            <button
                                className={`btn ${isLocked ? 'btn-danger' : 'btn-secondary'}`}
                                onClick={onToggleLock}
                                style={{ fontSize: '12px', padding: '6px 12px' }}
                            >
                                {isLocked ? 'Unlock' : 'Lock'}
                            </button>
                            {saveStatus && (
                                saveStatus.includes('Error') ? (
                                    <div className="save-error">
                                        {saveStatus}
                                        <button onClick={() => setSaveStatus('')}>×</button>
                                    </div>
                                ) : (
                                    <div className="save-status">{saveStatus}</div>
                                )
                            )}
                        </div>
                    </div>

                    <div className="staffing-layout">
                        <div className={`lines-container ${isLocked ? 'locked-overlay' : ''}`}>
                            {lines.map(line => (
                                <LineColumn
                                    key={line.id}
                                    line={line}
                                    isLocked={isLocked}
                                    coreAssociates={coreAssociates}
                                    selectMode={selectMode}
                                    selectedPositions={selectedPositions}
                                    onTogglePositionSelect={togglePositionSelect}
                                    onUpdatePosition={onUpdatePosition}
                                    onUpdateLine={onUpdateLine}
                                    onRemoveLine={onRemoveLine}
                                    onToggleCutLine={onToggleCutLine}
                                    onDragStart={selectMode ? (e) => e.preventDefault() : onDragStart}
                                    onDragOver={onDragOver}
                                    onDrop={onDrop}
                                />
                            ))}
                            <div className="line-column" style={{ minWidth: '120px', width: '120px', justifyContent: 'center', alignItems: 'center', cursor: isLocked ? 'not-allowed' : 'pointer', background: '#f9fafb', opacity: isLocked ? 0.5 : 1 }} onClick={isLocked ? null : onAddLine}>
                                <div style={{ textAlign: 'center', color: '#667eea', fontSize: '14px', fontWeight: '600' }}>
                                    <div style={{ fontSize: '32px', marginBottom: '8px' }}>+</div>
                                    <div>Add Line</div>
                                </div>
                            </div>
                        </div>

                        <div
                            className={`waitlist-sidebar ${isLocked ? 'locked-overlay' : ''}`}
                            onDragOver={isLocked || selectMode ? null : onDragOver}
                            onDrop={(e) => isLocked || selectMode ? e.preventDefault() : onDrop(e, { type: 'waitlist' })}
                        >
                            <div className="waitlist-header" style={isLocked ? {pointerEvents: 'auto'} : {}}>
                                WAITLIST ({waitlist.filter(w => w.name.trim()).length})
                                <div style={{ display: 'flex', gap: '4px', marginLeft: '8px' }}>
                                    <button
                                        className="btn btn-primary btn-small"
                                        onClick={() => setIsQuickAddOpen(true)}
                                        disabled={isLocked}
                                        style={{ fontSize: '11px', opacity: isLocked ? 0.5 : 1 }}
                                    >
                                        Quick Add
                                    </button>
                                    <button
                                        className="btn btn-success btn-small"
                                        onClick={onAddWaitlistItem}
                                        disabled={isLocked}
                                        style={{ opacity: isLocked ? 0.5 : 1 }}
                                    >
                                        + Add
                                    </button>
                                </div>
                            </div>
                            <div style={{ padding: '4px 6px' }}>
                                <input
                                    type="text"
                                    className="waitlist-input"
                                    placeholder="Search waitlist..."
                                    value={waitlistSearch}
                                    onChange={(e) => setWaitlistSearch(e.target.value)}
                                    style={{ fontSize: '11px', padding: '4px 6px' }}
                                />
                            </div>
                            <div className="waitlist-items">
                                {filteredWaitlist.map((item, idx) => (
                                    <div
                                        key={item.id}
                                        className="waitlist-item"
                                        draggable={!isLocked && !selectMode && item.name.trim() !== ''}
                                        onDragStart={(e) => (isLocked || selectMode) ? e.preventDefault() : onDragStart(e, { type: 'waitlist', id: item.id })}
                                        style={{ cursor: isLocked ? 'not-allowed' : selectMode ? 'pointer' : (item.name.trim() ? 'grab' : 'default'), opacity: isLocked ? 0.7 : 1 }}
                                        onClick={selectMode && item.name.trim() ? () => toggleWaitlistSelect(item.id) : undefined}
                                    >
                                        {selectMode && item.name.trim() && (
                                            <input type="checkbox"
                                                checked={selectedWaitlist.includes(item.id)}
                                                onChange={() => toggleWaitlistSelect(item.id)}
                                                onClick={(e) => e.stopPropagation()}
                                                style={{ width: '14px', height: '14px', flexShrink: 0 }}
                                            />
                                        )}
                                        <div style={{ fontSize: '10px', color: '#6b7280', fontWeight: '600' }}>
                                            #{idx + 1}
                                        </div>
                                        <input
                                            type="text"
                                            className="waitlist-input"
                                            value={item.name}
                                            onChange={(e) => onUpdateWaitlistItem(item.id, e.target.value, item.isNew)}
                                            placeholder="Type name..."
                                            disabled={isLocked}
                                        />
                                        <div className="waitlist-controls">
                                            <input
                                                type="checkbox"
                                                checked={item.isNew}
                                                onChange={(e) => onUpdateWaitlistItem(item.id, item.name, e.target.checked)}
                                                style={{ width: '14px', height: '14px' }}
                                                disabled={isLocked}
                                            />
                                            <label style={{ fontSize: '11px', flex: 1 }}>New</label>
                                            <button
                                                className="btn btn-danger btn-small"
                                                onClick={() => onRemoveWaitlistItem(item.id)}
                                                disabled={isLocked}
                                                style={{ opacity: isLocked ? 0.5 : 1 }}
                                            >
                                                ×
                                            </button>
                                        </div>
                                    </div>
                                ))}
                                {filteredWaitlist.length === 0 && (
                                    <div style={{ textAlign: 'center', padding: '20px', color: '#6b7280', fontSize: '12px' }}>
                                        {waitlistSearch ? 'No matches' : 'No one waiting'}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Bulk Action Bar */}
                    {selectMode && (selectedPositions.length > 0 || selectedWaitlist.length > 0) && (
                        <div className="bulk-action-bar">
                            <span>{selectedPositions.length + selectedWaitlist.length} selected</span>
                            {selectedPositions.length > 0 && (
                                <button style={{ background: '#f59e0b', color: 'white' }} onClick={handleBulkMoveToWaitlist}>
                                    Move to Waitlist
                                </button>
                            )}
                            <button style={{ background: '#ef4444', color: 'white' }} onClick={handleBulkClear}>
                                Clear Selected
                            </button>
                            <button style={{ background: '#6b7280', color: 'white' }} onClick={handleDeselectAll}>
                                Deselect All
                            </button>
                        </div>
                    )}

                    {/* Undo Banner */}
                    {undoMessage && (
                        <div className="undo-banner">
                            <span>{undoMessage}</span>
                            <button onClick={onUndo}>Undo</button>
                            <button onClick={() => setSaveStatus('')} style={{ background: 'transparent', padding: '4px 8px', fontSize: '16px' }}>×</button>
                        </div>
                    )}

                    {/* Quick Add Modal */}
                    {isQuickAddOpen && (
                        <div className="quick-add-modal" onClick={handleCancelQuickAdd}>
                            <div className="quick-add-content" onClick={(e) => e.stopPropagation()}>
                                <div className="quick-add-header">
                                    <h3 className="quick-add-title">Quick Add to Waitlist</h3>
                                    <button
                                        className="btn btn-secondary btn-small"
                                        onClick={handleCancelQuickAdd}
                                    >
                                        ×
                                    </button>
                                </div>

                                <input
                                    ref={quickAddInputRef}
                                    type="text"
                                    className="quick-add-input"
                                    value={quickAddInput}
                                    onChange={(e) => setQuickAddInput(e.target.value)}
                                    onKeyDown={handleQuickAddKeyPress}
                                    placeholder="Type a name and press Enter..."
                                />

                                <div className="quick-add-hint">
                                    Press Enter to add • Press Escape to close
                                </div>

                                {quickAddNames.length > 0 && (
                                    <div className="quick-add-list">
                                        {quickAddNames.map((name, index) => (
                                            <div key={index} className="quick-add-item">
                                                <span style={{ fontWeight: '500' }}>
                                                    {index + 1}. {name}
                                                </span>
                                                <button
                                                    className="btn btn-danger btn-small"
                                                    onClick={() => handleRemoveQuickAddName(index)}
                                                >
                                                    ×
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {quickAddNames.length === 0 && (
                                    <div style={{ textAlign: 'center', padding: '20px', color: '#9ca3af', fontSize: '13px', fontStyle: 'italic' }}>
                                        No names added yet
                                    </div>
                                )}

                                <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
                                    <button
                                        className="btn btn-secondary"
                                        onClick={handleCancelQuickAdd}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        className="btn btn-success"
                                        onClick={handleConfirmQuickAdd}
                                        disabled={quickAddNames.length === 0}
                                    >
                                        Add {quickAddNames.length} to Waitlist
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        }

        function LineColumn({ line, isLocked, coreAssociates, selectMode, selectedPositions, onTogglePositionSelect, onUpdatePosition, onUpdateLine, onRemoveLine, onToggleCutLine, onDragStart, onDragOver, onDrop }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editLetter, setEditLetter] = useState(line.letter);
            const [editLeads, setEditLeads] = useState((line.leads || []).join(', '));
            const [editNeeded, setEditNeeded] = useState(line.needed);

            const filledCount = line.positions.filter(p => p.name.trim()).length;
            const leads = line.leads || (line.lead ? [line.lead] : []);

            const handleSaveEdit = () => {
                const newLeadsArray = editLeads.split(',').map(l => l.trim()).filter(l => l);
                const oldLeadsArray = line.leads || [];
                const newNeeded = parseInt(editNeeded) || line.needed;

                // Find added and removed leads
                const addedLeads = newLeadsArray.filter(l => !oldLeadsArray.includes(l));
                const removedLeads = oldLeadsArray.filter(l => !newLeadsArray.includes(l));

                // Collect core members to add from new leads
                const coreToAdd = [];
                const ca = coreAssociates || {};
                addedLeads.forEach(lead => {
                    let members = ca[lead];
                    if (!members) {
                        const matchKey = Object.keys(ca).find(k => k.toLowerCase() === lead.toLowerCase());
                        members = matchKey ? ca[matchKey] : [];
                    }
                    members.forEach(m => {
                        // Don't add if already on this line
                        if (!line.positions.some(p => p.name.trim().toLowerCase() === m.name.trim().toLowerCase())) {
                            coreToAdd.push(m.name);
                        }
                    });
                });

                // Collect core member names from removed leads
                const coreToRemove = [];
                removedLeads.forEach(lead => {
                    let members = ca[lead];
                    if (!members) {
                        const matchKey = Object.keys(ca).find(k => k.toLowerCase() === lead.toLowerCase());
                        members = matchKey ? ca[matchKey] : [];
                    }
                    members.forEach(m => {
                        // Only remove if they're actually on this line
                        if (line.positions.some(p => p.name.trim().toLowerCase() === m.name.trim().toLowerCase())) {
                            coreToRemove.push(m.name.toLowerCase());
                        }
                    });
                });

                // Handle removed leads' core members
                let updatedPositions = [...line.positions];
                if (coreToRemove.length > 0) {
                    const shouldRemove = confirm(
                        `The following core members belong to removed lead(s):\n${coreToRemove.map(n => '  - ' + n).join('\n')}\n\nRemove them from this line?`
                    );
                    if (shouldRemove) {
                        updatedPositions = updatedPositions.map(p => {
                            if (coreToRemove.includes(p.name.trim().toLowerCase())) {
                                return { ...p, name: '', isNew: false };
                            }
                            return p;
                        });
                    }
                }

                // Handle added leads' core members - fill empty slots
                if (coreToAdd.length > 0) {
                    let addIndex = 0;
                    // First pass: adjust positions count if needed
                    let totalNeeded = newNeeded;
                    const currentFilled = updatedPositions.filter(p => p.name.trim()).length;
                    const emptySlots = updatedPositions.filter(p => !p.name.trim()).length;

                    if (coreToAdd.length > emptySlots) {
                        // Need more positions
                        totalNeeded = Math.max(newNeeded, currentFilled + coreToAdd.length);
                    }

                    // Fill empty positions with core members
                    updatedPositions = updatedPositions.map(p => {
                        if (!p.name.trim() && addIndex < coreToAdd.length) {
                            const name = coreToAdd[addIndex];
                            addIndex++;
                            return { ...p, name: name, isNew: false };
                        }
                        return p;
                    });

                    // If we still have members to add, create new positions
                    while (addIndex < coreToAdd.length) {
                        updatedPositions.push({
                            id: Date.now() + Math.random() + addIndex,
                            name: coreToAdd[addIndex],
                            isNew: false
                        });
                        addIndex++;
                        totalNeeded = Math.max(totalNeeded, updatedPositions.length);
                    }

                    // Update needed count if we added positions
                    if (totalNeeded > newNeeded) {
                        onUpdateLine(line.id, {
                            letter: editLetter,
                            leads: newLeadsArray,
                            needed: totalNeeded,
                            positions: updatedPositions
                        });
                        setEditNeeded(totalNeeded);
                        setIsEditing(false);
                        return;
                    }
                }

                // Adjust positions array for needed count changes
                if (newNeeded > updatedPositions.length) {
                    const additionalPositions = Array(newNeeded - updatedPositions.length)
                        .fill(null)
                        .map((_, idx) => ({
                            id: Date.now() + Math.random() + idx,
                            name: '',
                            isNew: false
                        }));
                    updatedPositions = [...updatedPositions, ...additionalPositions];
                } else if (newNeeded < updatedPositions.length) {
                    const wouldLose = updatedPositions.slice(newNeeded).filter(p => p.name.trim());
                    if (wouldLose.length > 0) {
                        const names = wouldLose.map(p => p.name).join(', ');
                        if (!confirm(`Reducing positions will remove: ${names}\n\nContinue?`)) {
                            setIsEditing(false);
                            return;
                        }
                    }
                    updatedPositions = updatedPositions.slice(0, newNeeded);
                }

                onUpdateLine(line.id, {
                    letter: editLetter,
                    leads: newLeadsArray,
                    needed: newNeeded,
                    positions: updatedPositions
                });
                setIsEditing(false);
            };

            const handleCancelEdit = () => {
                setEditLetter(line.letter);
                setEditLeads((line.leads || []).join(', '));
                setEditNeeded(line.needed);
                setIsEditing(false);
            };

            return (
                <div className={`line-column ${line.isCut ? 'cut' : ''}`} style={{ position: 'relative' }}>
                    {line.isCut && <div className="cut-badge">CUT</div>}
                    <div className="line-header">
                        {!isEditing ? (
                            <>
                                <div className="line-letter">Line {line.letter || '?'}</div>
                                <div className="line-lead">
                                    {leads.length > 0 ? leads.join(', ') : 'No lead'}
                                </div>
                                <div className="line-stats">{filledCount} / {line.needed} filled</div>
                                <div className="line-edit-controls">
                                    <button
                                        className="btn btn-secondary btn-small"
                                        onClick={() => onToggleCutLine(line.id)}
                                        disabled={isLocked}
                                        style={{ fontSize: '10px', padding: '3px 6px', background: line.isCut ? '#10b981' : '#ef4444', color: 'white', border: 'none', opacity: isLocked ? 0.5 : 1 }}
                                    >
                                        {line.isCut ? 'Restore' : 'Cut'}
                                    </button>
                                    <button
                                        className="btn btn-secondary btn-small"
                                        onClick={() => setIsEditing(true)}
                                        disabled={isLocked}
                                        style={{ fontSize: '10px', padding: '3px 6px', opacity: isLocked ? 0.5 : 1 }}
                                    >
                                        Edit
                                    </button>
                                    <button
                                        className="btn btn-danger btn-small"
                                        onClick={() => onRemoveLine(line.id)}
                                        disabled={isLocked}
                                        style={{ fontSize: '10px', padding: '3px 6px', opacity: isLocked ? 0.5 : 1 }}
                                    >
                                        Remove
                                    </button>
                                </div>
                            </>
                        ) : (
                            <>
                                <div style={{ fontSize: '10px', marginBottom: '4px', opacity: 0.9 }}>Edit Line</div>
                                <input
                                    type="text"
                                    className="line-edit-input"
                                    value={editLetter}
                                    onChange={(e) => setEditLetter(e.target.value.toUpperCase())}
                                    placeholder="Letter (A, B, C...)"
                                    maxLength="2"
                                />
                                <input
                                    type="text"
                                    className="line-edit-input"
                                    value={editLeads}
                                    onChange={(e) => setEditLeads(e.target.value)}
                                    placeholder="Leads (comma-separated)"
                                />
                                <input
                                    type="number"
                                    className="line-edit-input"
                                    value={editNeeded}
                                    onChange={(e) => setEditNeeded(e.target.value)}
                                    placeholder="Quantity"
                                    min="1"
                                />
                                <div className="line-edit-controls">
                                    <button
                                        className="btn btn-success btn-small"
                                        onClick={handleSaveEdit}
                                        style={{ fontSize: '10px', padding: '3px 6px' }}
                                    >
                                        Save
                                    </button>
                                    <button
                                        className="btn btn-secondary btn-small"
                                        onClick={handleCancelEdit}
                                        style={{ fontSize: '10px', padding: '3px 6px' }}
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </>
                        )}
                    </div>
                    <div className="positions-list">
                        {line.positions.map((position, index) => (
                            <div
                                key={position.id}
                                className={`position-slot ${position.name.trim() ? 'filled' : ''} ${position.isNew ? 'new-associate' : ''}`}
                                draggable={!isLocked && !selectMode && position.name.trim() !== '' && !line.isCut}
                                onDragStart={(e) => (isLocked || selectMode) ? e.preventDefault() : onDragStart(e, { type: 'position', lineId: line.id, positionId: position.id })}
                                onDragOver={selectMode ? null : onDragOver}
                                onDrop={(e) => (isLocked || selectMode) ? e.preventDefault() : onDrop(e, { type: 'position', lineId: line.id, positionId: position.id })}
                                style={{ cursor: isLocked ? 'not-allowed' : selectMode ? 'pointer' : (position.name.trim() && !line.isCut ? 'grab' : 'default'), position: 'relative' }}
                                onClick={selectMode && position.name.trim() ? () => onTogglePositionSelect(line.id, position.id) : undefined}
                            >
                                {selectMode && position.name.trim() && (
                                    <input type="checkbox" className="bulk-checkbox"
                                        checked={!!(selectedPositions || []).find(s => s.lineId === line.id && s.positionId === position.id)}
                                        onChange={() => onTogglePositionSelect(line.id, position.id)}
                                        onClick={(e) => e.stopPropagation()}
                                        style={{ width: '14px', height: '14px' }}
                                    />
                                )}
                                <div className="position-number">{index + 1}</div>
                                <input
                                    type="text"
                                    className="position-input"
                                    value={position.name}
                                    onChange={(e) => onUpdatePosition(line.id, position.id, e.target.value, position.isNew)}
                                    placeholder="Name..."
                                    disabled={line.isCut || isLocked}
                                />
                                <div className="position-checkbox">
                                    <input
                                        type="checkbox"
                                        checked={position.isNew}
                                        onChange={(e) => onUpdatePosition(line.id, position.id, position.name, e.target.checked)}
                                        disabled={line.isCut || isLocked}
                                    />
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function SetupView({ onSetupShift, coreAssociates, initialDate, initialShift }) {
            const [date, setDate] = useState(initialDate);
            const [shift, setShift] = useState(initialShift);
            const [lines, setLines] = useState([{ letter: '', leads: [], leadInput: '', needed: '' }]);
            const [showClone, setShowClone] = useState(false);
            const [cloneOptions, setCloneOptions] = useState([]);

            const loadCloneOptions = async () => {
                const options = [];
                if (isFirebaseConfigured && db) {
                    try {
                        const snapshot = await db.ref('staffing').once('value');
                        if (snapshot.exists()) {
                            Object.entries(snapshot.val()).forEach(([id, data]) => {
                                options.push({ id, date: data.date, shift: data.shift, lines: data.lines || [] });
                            });
                        }
                    } catch (e) { console.error('Error loading clone options:', e); }
                }
                const localKeys = Object.keys(localStorage).filter(k => k.startsWith('staffing_') && !k.includes('coreAssociates'));
                localKeys.forEach(key => {
                    const data = storage.load(key);
                    if (data && !options.find(o => o.id === `${data.date}_${data.shift}`)) {
                        options.push({ id: `${data.date}_${data.shift}`, date: data.date, shift: data.shift, lines: data.lines || [] });
                    }
                });
                options.sort((a, b) => b.date.localeCompare(a.date));
                setCloneOptions(options);
                setShowClone(true);
            };

            const handleClone = (option) => {
                const clonedLines = option.lines.filter(l => !l.isCut).map(l => ({
                    letter: l.letter || '',
                    leads: l.leads || [],
                    leadInput: '',
                    needed: String(l.needed || '')
                }));
                if (clonedLines.length > 0) {
                    setLines(clonedLines);
                }
                setShowClone(false);
            };

            const handleAddLine = () => {
                setLines([...lines, { letter: '', leads: [], leadInput: '', needed: '' }]);
            };

            const handleRemoveLine = (index) => {
                setLines(lines.filter((_, i) => i !== index));
            };

            const handleLineChange = (index, field, value) => {
                const newLines = [...lines];
                newLines[index][field] = value;
                setLines(newLines);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();

                // Check if staffing sheet already exists for this date/shift
                const docId = `${date}_${shift}`;
                let existsInFirebase = false;
                let existsInLocalStorage = false;

                // Check Firebase
                if (isFirebaseConfigured && db) {
                    try {
                        const snapshot = await db.ref('staffing/' + docId).once('value');
                        existsInFirebase = snapshot.exists();
                    } catch (error) {
                        console.error('Error checking Firebase:', error);
                    }
                }

                // Check localStorage
                const localData = storage.load(`staffing_${date}_${shift}`, null);
                existsInLocalStorage = localData !== null;

                // If exists, prevent creating a new one
                if (existsInFirebase || existsInLocalStorage) {
                    const location = existsInFirebase ? 'cloud' : 'local storage';
                    const confirmed = confirm(
                        `A staffing sheet already exists for ${date} - ${shift} Shift (saved in ${location}).\n\n` +
                        `Only one staffing sheet can exist per date and shift to prevent data conflicts.\n\n` +
                        `Would you like to load the existing sheet instead?`
                    );

                    if (confirmed) {
                        // Load the existing sheet instead
                        onSetupShift({ date, shift, loadExisting: true });
                    }
                    return; // Don't create a new sheet
                }

                const validLines = lines.filter(l => l.letter && l.leads.length > 0 && l.needed).map(l => ({
                    ...l,
                    leads: l.leads
                }));
                if (validLines.length > 0) {
                    onSetupShift({ date, shift, lines: validLines });
                } else {
                    alert('Please fill in all fields for at least one line.');
                }
            };

            const allLeads = Object.keys(coreAssociates);

            return (
                <form onSubmit={handleSubmit} className="setup-form">
                    <div className="form-section">
                        <h3>Shift Information</h3>
                        <div className="form-grid">
                            <div className="form-group">
                                <label>Date *</label>
                                <input
                                    type="date"
                                    value={date}
                                    onChange={(e) => setDate(e.target.value)}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>Shift *</label>
                                <select value={shift} onChange={(e) => setShift(e.target.value)} required>
                                    <option>1st</option>
                                    <option>2nd</option>
                                    <option>Swing</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div className="form-section">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                            <h3 style={{ margin: 0 }}>Configure Production Lines</h3>
                            <button type="button" className="btn btn-secondary btn-small" onClick={loadCloneOptions}
                                style={{ background: '#667eea', color: 'white', border: 'none' }}>
                                Clone Previous Shift
                            </button>
                        </div>
                        {showClone && (
                            <div style={{ background: '#f0f2f5', border: '1px solid #d1d5db', borderRadius: '6px', padding: '12px', marginBottom: '12px', maxHeight: '200px', overflowY: 'auto' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                                    <strong style={{ fontSize: '12px' }}>Select a shift to clone:</strong>
                                    <button type="button" className="btn btn-secondary btn-small" onClick={() => setShowClone(false)}>×</button>
                                </div>
                                {cloneOptions.length === 0 ? (
                                    <p style={{ fontSize: '12px', color: '#6b7280' }}>No previous shifts found.</p>
                                ) : cloneOptions.map(opt => (
                                    <div key={opt.id} onClick={() => handleClone(opt)}
                                        style={{ padding: '8px', background: 'white', borderRadius: '4px', marginBottom: '4px', cursor: 'pointer', fontSize: '12px', border: '1px solid #e5e7eb' }}>
                                        <strong>{opt.date}</strong> - {opt.shift} Shift ({opt.lines.filter(l => !l.isCut).length} lines)
                                    </div>
                                ))}
                            </div>
                        )}
                        {lines.map((line, index) => (
                            <div key={index} className="form-grid" style={{ marginBottom: '12px', padding: '12px', background: 'white', borderRadius: '6px' }}>
                                <div className="form-group">
                                    <label>Line Letter *</label>
                                    <input
                                        type="text"
                                        value={line.letter}
                                        onChange={(e) => handleLineChange(index, 'letter', e.target.value.toUpperCase())}
                                        placeholder="A, B, C..."
                                        required
                                        maxLength="2"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Line Lead(s) *</label>
                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px', marginBottom: line.leads.length > 0 ? '6px' : '0' }}>
                                        {line.leads.map((lead, li) => (
                                            <span key={li} style={{ display: 'inline-flex', alignItems: 'center', gap: '4px', background: '#667eea', color: 'white', padding: '3px 8px', borderRadius: '4px', fontSize: '12px', fontWeight: '600' }}>
                                                {lead}
                                                <button type="button" onClick={() => {
                                                    const newLines = [...lines];
                                                    newLines[index] = { ...newLines[index], leads: newLines[index].leads.filter((_, i) => i !== li) };
                                                    setLines(newLines);
                                                }} style={{ background: 'none', border: 'none', color: 'white', cursor: 'pointer', fontWeight: 'bold', fontSize: '14px', lineHeight: '1', padding: '0 2px' }}>×</button>
                                            </span>
                                        ))}
                                    </div>
                                    <div style={{ display: 'flex', gap: '4px' }}>
                                        <input
                                            type="text"
                                            list={`leads-${index}`}
                                            value={line.leadInput || ''}
                                            onChange={(e) => {
                                                const val = e.target.value;
                                                // Auto-add if user selected from datalist (exact match to a known lead)
                                                if (allLeads.includes(val) && !line.leads.includes(val)) {
                                                    const newLines = [...lines];
                                                    newLines[index] = { ...newLines[index], leads: [...newLines[index].leads, val], leadInput: '' };
                                                    setLines(newLines);
                                                } else {
                                                    handleLineChange(index, 'leadInput', val);
                                                }
                                            }}
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter') {
                                                    e.preventDefault();
                                                    const val = (line.leadInput || '').trim();
                                                    if (val && !line.leads.includes(val)) {
                                                        const newLines = [...lines];
                                                        newLines[index] = { ...newLines[index], leads: [...newLines[index].leads, val], leadInput: '' };
                                                        setLines(newLines);
                                                    }
                                                }
                                            }}
                                            placeholder={line.leads.length === 0 ? 'Type or select a lead name...' : 'Add another lead...'}
                                            style={{ flex: 1 }}
                                        />
                                        <button type="button" className="btn btn-success btn-small" onClick={() => {
                                            const val = (line.leadInput || '').trim();
                                            if (val && !line.leads.includes(val)) {
                                                const newLines = [...lines];
                                                newLines[index] = { ...newLines[index], leads: [...newLines[index].leads, val], leadInput: '' };
                                                setLines(newLines);
                                            }
                                        }}>Add</button>
                                    </div>
                                    <datalist id={`leads-${index}`}>
                                        {allLeads.filter(l => !line.leads.includes(l)).map(lead => (
                                            <option key={lead} value={lead} />
                                        ))}
                                    </datalist>
                                </div>
                                <div className="form-group">
                                    <label>Associates Needed *</label>
                                    <input
                                        type="number"
                                        value={line.needed}
                                        onChange={(e) => handleLineChange(index, 'needed', e.target.value)}
                                        placeholder="Number"
                                        required
                                        min="1"
                                        max="50"
                                    />
                                </div>
                                {lines.length > 1 && (
                                    <div style={{ display: 'flex', alignItems: 'flex-end' }}>
                                        <button
                                            type="button"
                                            className="btn btn-danger btn-small"
                                            onClick={() => handleRemoveLine(index)}
                                        >
                                            Remove
                                        </button>
                                    </div>
                                )}
                            </div>
                        ))}
                        <button type="button" className="btn btn-success" onClick={handleAddLine} style={{ marginTop: '12px' }}>
                            + Add Another Line
                        </button>
                    </div>

                    <button type="submit" className="btn btn-success" style={{ fontSize: '14px', padding: '10px 20px' }}>
                        Start Staffing
                    </button>
                </form>
            );
        }

        function ReportingView({ onLoadShift }) {
            const [reports, setReports] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchDate, setSearchDate] = useState('');
            const [collapsedMonths, setCollapsedMonths] = useState({});
            const [showComparison, setShowComparison] = useState(false);
            const [compareIdA, setCompareIdA] = useState('');
            const [compareIdB, setCompareIdB] = useState('');

            useEffect(() => {
                loadReports();
            }, []);

            const loadReports = async () => {
                setLoading(true);
                const reportsList = [];
                const firebaseReportIds = new Set();

                // Load from Firebase if configured
                if (isFirebaseConfigured && db) {
                    try {
                        const snapshot = await db.ref('staffing').once('value');
                        if (snapshot.exists()) {
                            const staffingData = snapshot.val();
                            Object.keys(staffingData).forEach(docId => {
                                const data = staffingData[docId];
                                reportsList.push({ id: docId, ...data, syncedToCloud: true });
                                firebaseReportIds.add(docId);
                            });
                        }
                        console.log('Loaded from Firebase Realtime Database:', reportsList.length, 'reports');
                    } catch (error) {
                        console.error('Error loading Firebase reports:', error);
                        alert('Error loading from Firebase: ' + error.message);
                    }
                }

                // Also check localStorage
                const localKeys = Object.keys(localStorage)
                    .filter(key => key.startsWith('staffing_'))
                    .filter(key => !key.includes('coreAssociates'));

                localKeys.forEach(key => {
                    const data = storage.load(key);
                    const reportId = `${data.date}_${data.shift}`;
                    if (data && !reportsList.find(r => r.id === reportId)) {
                        reportsList.push({ id: reportId, ...data, syncedToCloud: false });
                    }
                });

                // Sort by date and shift (client-side)
                reportsList.sort((a, b) => {
                    if (a.date !== b.date) return b.date.localeCompare(a.date);
                    return a.shift.localeCompare(b.shift);
                });

                console.log('Total reports loaded:', reportsList.length);
                setReports(reportsList);
                setLoading(false);
            };

            // Get current week boundaries (Sunday to Saturday)
            const getWeekBounds = () => {
                const now = new Date();
                const dayOfWeek = now.getDay();
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - dayOfWeek);
                startOfWeek.setHours(0, 0, 0, 0);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                endOfWeek.setHours(23, 59, 59, 999);
                return { start: startOfWeek, end: endOfWeek };
            };

            const getMonthKey = (dateStr) => {
                const d = new Date(dateStr + 'T00:00:00');
                return d.toLocaleString('default', { month: 'long', year: 'numeric' });
            };

            const toggleMonth = (monthKey) => {
                setCollapsedMonths(prev => ({ ...prev, [monthKey]: !prev[monthKey] }));
            };

            const renderReportItem = (report) => {
                const totalPositions = (report.lines || []).reduce((sum, line) => sum + line.needed, 0);
                const filledPositions = (report.lines || []).reduce((sum, line) =>
                    sum + line.positions.filter(p => p.name && p.name.trim()).length, 0
                );

                return (
                    <div
                        key={report.id}
                        className="report-item"
                        onClick={() => onLoadShift(report.date, report.shift)}
                    >
                        <h4>
                            {report.date} - {report.shift} Shift
                            {report.syncedToCloud ? (
                                <span className="cloud-badge synced">☁ Synced</span>
                            ) : (
                                <span className="cloud-badge local-only">📱 Local Only</span>
                            )}
                        </h4>
                        <p>
                            {filledPositions} / {totalPositions} positions filled
                            {report.waitlist && report.waitlist.length > 0 && ` • ${report.waitlist.filter(w => w.name && w.name.trim()).length} waiting`}
                        </p>
                        {report.lastUpdated && (
                            <p style={{ fontSize: '11px', marginTop: '4px' }}>
                                Last updated: {new Date(report.lastUpdated).toLocaleString()}
                            </p>
                        )}
                    </div>
                );
            };

            // Filter reports by search date
            const filteredReports = searchDate
                ? reports.filter(r => r.date === searchDate)
                : reports;

            // Split into current week and older
            const weekBounds = getWeekBounds();
            const thisWeekReports = filteredReports.filter(r => {
                const d = new Date(r.date + 'T00:00:00');
                return d >= weekBounds.start && d <= weekBounds.end;
            });
            const olderReports = filteredReports.filter(r => {
                const d = new Date(r.date + 'T00:00:00');
                return d < weekBounds.start;
            });

            // Group older reports by month
            const monthGroups = {};
            olderReports.forEach(r => {
                const key = getMonthKey(r.date);
                if (!monthGroups[key]) monthGroups[key] = [];
                monthGroups[key].push(r);
            });
            const sortedMonthKeys = Object.keys(monthGroups).sort((a, b) => {
                // Sort descending by parsing month/year
                const da = new Date(monthGroups[a][0].date + 'T00:00:00');
                const db2 = new Date(monthGroups[b][0].date + 'T00:00:00');
                return db2 - da;
            });

            return (
                <div>
                    <div className="report-controls">
                        <h3 style={{ marginBottom: '8px' }}>Saved Staffing Reports</h3>
                        <p style={{ fontSize: '12px', color: '#6b7280', marginBottom: '12px' }}>
                            View and load previous staffing sheets
                        </p>
                        <div style={{ display: 'flex', gap: '12px', alignItems: 'center', flexWrap: 'wrap' }}>
                            <div className="form-group" style={{ margin: 0, flex: '0 0 auto' }}>
                                <label style={{ fontSize: '12px', fontWeight: '600', marginBottom: '4px' }}>Search by Date</label>
                                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                    <input
                                        type="date"
                                        value={searchDate}
                                        onChange={(e) => setSearchDate(e.target.value)}
                                        style={{ padding: '6px 10px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '13px' }}
                                    />
                                    {searchDate && (
                                        <button
                                            className="btn btn-secondary btn-small"
                                            onClick={() => setSearchDate('')}
                                        >
                                            Clear
                                        </button>
                                    )}
                                </div>
                            </div>
                            <div style={{ fontSize: '12px', color: '#6b7280' }}>
                                {filteredReports.length} report{filteredReports.length !== 1 ? 's' : ''} found
                            </div>
                            {reports.length >= 2 && (
                                <button
                                    className={`btn ${showComparison ? 'btn-primary' : 'btn-secondary'}`}
                                    onClick={() => setShowComparison(!showComparison)}
                                    style={{ fontSize: '12px', padding: '6px 14px', marginLeft: 'auto' }}
                                >
                                    {showComparison ? 'Hide Compare' : 'Compare'}
                                </button>
                            )}
                        </div>
                    </div>

                    {showComparison && (
                        <div style={{ padding: '16px', background: '#f9fafb', border: '1px solid #e5e7eb', borderRadius: '8px', marginBottom: '16px' }}>
                            <h4 style={{ fontSize: '14px', marginBottom: '12px' }}>Shift Comparison</h4>
                            <div style={{ display: 'flex', gap: '12px', marginBottom: '16px', flexWrap: 'wrap' }}>
                                <div className="form-group" style={{ margin: 0, flex: 1, minWidth: '200px' }}>
                                    <label style={{ fontSize: '12px', fontWeight: '600' }}>Shift A</label>
                                    <select value={compareIdA} onChange={(e) => setCompareIdA(e.target.value)} style={{ padding: '6px 10px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px', width: '100%' }}>
                                        <option value="">-- Select --</option>
                                        {reports.map(r => (
                                            <option key={r.id} value={r.id}>{r.date} - {r.shift}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group" style={{ margin: 0, flex: 1, minWidth: '200px' }}>
                                    <label style={{ fontSize: '12px', fontWeight: '600' }}>Shift B</label>
                                    <select value={compareIdB} onChange={(e) => setCompareIdB(e.target.value)} style={{ padding: '6px 10px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '12px', width: '100%' }}>
                                        <option value="">-- Select --</option>
                                        {reports.map(r => (
                                            <option key={r.id} value={r.id}>{r.date} - {r.shift}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            {compareIdA && compareIdB && (() => {
                                const dataA = reports.find(r => r.id === compareIdA);
                                const dataB = reports.find(r => r.id === compareIdB);
                                if (!dataA || !dataB) return null;

                                const getNamesSet = (data) => {
                                    const names = new Set();
                                    (data.lines || []).forEach(l => l.positions.forEach(p => { if (p.name && p.name.trim()) names.add(p.name.trim()); }));
                                    (data.waitlist || []).forEach(w => { if (w.name && w.name.trim()) names.add(w.name.trim()); });
                                    return names;
                                };

                                const namesA = getNamesSet(dataA);
                                const namesB = getNamesSet(dataB);
                                const onlyA = [...namesA].filter(n => !namesB.has(n));
                                const onlyB = [...namesB].filter(n => !namesA.has(n));
                                const both = [...namesA].filter(n => namesB.has(n));

                                return (
                                    <div>
                                        <div className="comparison-stats">
                                            <div className="comparison-stat" style={{ background: '#fee2e2', color: '#991b1b' }}>
                                                {onlyA.length} removed
                                            </div>
                                            <div className="comparison-stat" style={{ background: '#d1fae5', color: '#065f46' }}>
                                                {onlyB.length} added
                                            </div>
                                            <div className="comparison-stat" style={{ background: '#f3f4f6', color: '#374151' }}>
                                                {both.length} same
                                            </div>
                                        </div>
                                        <div className="comparison-container">
                                            <div className="comparison-side">
                                                <h4>{dataA.date} - {dataA.shift} ({namesA.size} people)</h4>
                                                <div style={{ padding: '8px' }}>
                                                    {[...namesA].sort().map(name => (
                                                        <div key={name} className={`comparison-name ${namesB.has(name) ? 'same' : 'removed'}`}>
                                                            {name} {!namesB.has(name) && '(not in B)'}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="comparison-side">
                                                <h4>{dataB.date} - {dataB.shift} ({namesB.size} people)</h4>
                                                <div style={{ padding: '8px' }}>
                                                    {[...namesB].sort().map(name => (
                                                        <div key={name} className={`comparison-name ${namesA.has(name) ? 'same' : 'added'}`}>
                                                            {name} {!namesA.has(name) && '(not in A)'}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })()}
                        </div>
                    )}

                    {loading ? (
                        <div className="empty-state">
                            <p>Loading reports...</p>
                        </div>
                    ) : filteredReports.length === 0 ? (
                        <div className="empty-state">
                            <h3>{searchDate ? 'No Reports Found' : 'No Reports Available'}</h3>
                            <p>{searchDate ? `No staffing sheets found for ${searchDate}.` : 'Staffing sheets will appear here after you save them.'}</p>
                        </div>
                    ) : (
                        <div>
                            {/* This Week Section */}
                            {!searchDate && thisWeekReports.length > 0 && (
                                <div style={{ marginBottom: '24px' }}>
                                    <h4 style={{ fontSize: '14px', color: '#111827', marginBottom: '10px', padding: '8px 12px', background: '#ecfdf5', borderRadius: '6px', border: '1px solid #10b981' }}>
                                        This Week
                                        <span style={{ fontSize: '12px', fontWeight: 'normal', color: '#6b7280', marginLeft: '8px' }}>
                                            ({thisWeekReports.length} report{thisWeekReports.length !== 1 ? 's' : ''})
                                        </span>
                                    </h4>
                                    <div className="report-list">
                                        {thisWeekReports.map(renderReportItem)}
                                    </div>
                                </div>
                            )}

                            {/* Search results - show flat list */}
                            {searchDate && (
                                <div className="report-list">
                                    {filteredReports.map(renderReportItem)}
                                </div>
                            )}

                            {/* Older reports grouped by month */}
                            {!searchDate && sortedMonthKeys.length > 0 && (
                                <div>
                                    {sortedMonthKeys.map(monthKey => {
                                        const isCollapsed = collapsedMonths[monthKey] !== false; // collapsed by default
                                        const monthReports = monthGroups[monthKey];
                                        return (
                                            <div key={monthKey} style={{ marginBottom: '12px' }}>
                                                <button
                                                    onClick={() => toggleMonth(monthKey)}
                                                    style={{
                                                        width: '100%',
                                                        padding: '10px 12px',
                                                        background: '#f3f4f6',
                                                        border: '1px solid #d1d5db',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer',
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center',
                                                        fontSize: '14px',
                                                        fontWeight: '600',
                                                        color: '#374151',
                                                        transition: 'background 0.2s'
                                                    }}
                                                >
                                                    <span>{monthKey}</span>
                                                    <span style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                        <span style={{ fontSize: '12px', fontWeight: 'normal', color: '#6b7280' }}>
                                                            {monthReports.length} report{monthReports.length !== 1 ? 's' : ''}
                                                        </span>
                                                        <span style={{ fontSize: '12px' }}>{isCollapsed ? '▶' : '▼'}</span>
                                                    </span>
                                                </button>
                                                {!isCollapsed && (
                                                    <div className="report-list" style={{ marginTop: '8px' }}>
                                                        {monthReports.map(renderReportItem)}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const AVAILABLE_FLAGS = [
            { id: 'sitdown', label: 'Sit-Down', className: 'flag-sitdown' },
            { id: 'sanitation', label: 'Sanitation', className: 'flag-sanitation' },
            { id: 'office', label: 'Office Support', className: 'flag-office' },
            { id: 'high', label: 'High Performer', className: 'flag-high' },
            { id: 'low', label: 'Low Performer', className: 'flag-low' }
        ];

        function FlagsDropdown({ flags = [], onChange, inForm = false }) {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };

                if (isOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                }

                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [isOpen]);

            const toggleFlag = (flagId) => {
                const newFlags = flags.includes(flagId)
                    ? flags.filter(f => f !== flagId)
                    : [...flags, flagId];
                onChange(newFlags);
            };

            const selectedFlagsText = flags.length > 0
                ? flags.map(fid => AVAILABLE_FLAGS.find(f => f.id === fid)?.label).filter(Boolean).join(', ')
                : 'Click to select flags...';

            return (
                <div className="flag-dropdown" ref={dropdownRef}>
                    {inForm ? (
                        <button
                            type="button"
                            className="flag-dropdown-button"
                            onClick={() => setIsOpen(!isOpen)}
                        >
                            <span style={{ color: flags.length === 0 ? '#9ca3af' : '#111827' }}>
                                {selectedFlagsText}
                            </span>
                            <span style={{ fontSize: '10px', color: '#6b7280' }}>
                                {isOpen ? '▲' : '▼'}
                            </span>
                        </button>
                    ) : (
                        <button
                            type="button"
                            className="btn btn-secondary btn-small"
                            onClick={() => setIsOpen(!isOpen)}
                            style={{ fontSize: '11px' }}
                        >
                            Edit Flags ({flags.length})
                        </button>
                    )}
                    {isOpen && (
                        <div className="flag-dropdown-content">
                            <div style={{ fontSize: '11px', fontWeight: '600', color: '#6b7280', marginBottom: '8px', paddingBottom: '6px', borderBottom: '1px solid #e5e7eb' }}>
                                Select Flags:
                            </div>
                            {AVAILABLE_FLAGS.map(flag => (
                                <div key={flag.id} className="flag-option">
                                    <input
                                        type="checkbox"
                                        checked={flags.includes(flag.id)}
                                        onChange={() => toggleFlag(flag.id)}
                                        id={`flag-${flag.id}-${Math.random()}`}
                                    />
                                    <label
                                        style={{ cursor: 'pointer', flex: 1 }}
                                        onClick={() => toggleFlag(flag.id)}
                                    >
                                        {flag.label}
                                    </label>
                                </div>
                            ))}
                            {flags.length === 0 && (
                                <div style={{ fontSize: '11px', color: '#9ca3af', padding: '8px', textAlign: 'center', fontStyle: 'italic' }}>
                                    No flags selected
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function CoreAssociatesView({ coreAssociates, lineLeadNotes, onAddCoreAssociate, onRemoveCoreAssociate, onUpdateCoreAssociate, onDeleteLineLead, onRenameLineLead, onUpdateLineLeadNotes, firebaseStatus }) {
            const [viewMode, setViewMode] = useState('byLead'); // 'byLead' or 'all'
            const [selectedLead, setSelectedLead] = useState('');
            const [newLead, setNewLead] = useState('');
            const [newName, setNewName] = useState('');
            const [newFlags, setNewFlags] = useState([]);
            const [filterFlags, setFilterFlags] = useState([]);
            const [sortBy, setSortBy] = useState('name'); // 'name' or flag id
            const [searchQuery, setSearchQuery] = useState('');
            const [isEditingLead, setIsEditingLead] = useState(false);
            const [editLeadName, setEditLeadName] = useState('');
            const [editLeadNotes, setEditLeadNotes] = useState('');

            const allLeads = Object.keys(coreAssociates);

            // Get all associates across all leads for "All" view
            const getAllAssociates = () => {
                const all = [];
                Object.entries(coreAssociates).forEach(([lead, associates]) => {
                    associates.forEach((assoc, index) => {
                        all.push({
                            ...assoc,
                            lead: lead,
                            leadIndex: index,
                            flags: assoc.flags || []
                        });
                    });
                });
                return all;
            };

            const getFilteredAssociates = () => {
                let associates = viewMode === 'all' ? getAllAssociates() : (coreAssociates[selectedLead || newLead] || []).map(a => ({ ...a, flags: a.flags || [] }));

                // Apply search filter
                if (searchQuery.trim()) {
                    associates = associates.filter(assoc =>
                        assoc.name.toLowerCase().includes(searchQuery.toLowerCase())
                    );
                }

                // Apply flag filters
                if (filterFlags.length > 0) {
                    associates = associates.filter(assoc =>
                        filterFlags.every(flag => (assoc.flags || []).includes(flag))
                    );
                }

                // Sort
                return [...associates].sort((a, b) => {
                    if (sortBy === 'name') {
                        return a.name.localeCompare(b.name);
                    } else {
                        const aHasFlag = (a.flags || []).includes(sortBy) ? 1 : 0;
                        const bHasFlag = (b.flags || []).includes(sortBy) ? 1 : 0;
                        return bHasFlag - aHasFlag;
                    }
                });
            };

            const handleAddAssociate = (e) => {
                e.preventDefault();
                const currentLead = selectedLead || newLead;
                if (currentLead && newName) {
                    onAddCoreAssociate(currentLead, {
                        name: newName,
                        flags: newFlags
                    });
                    setNewName('');
                    setNewFlags([]);
                    if (newLead) {
                        setSelectedLead(newLead);
                        setNewLead('');
                    }
                }
            };

            const handleUpdateAssociateFlags = (lead, index, newFlags) => {
                onUpdateCoreAssociate(lead, index, { flags: newFlags });
            };

            const handleStartEditLead = () => {
                setEditLeadName(selectedLead);
                setEditLeadNotes((lineLeadNotes || {})[selectedLead] || '');
                setIsEditingLead(true);
            };

            const handleSaveEditLead = () => {
                const trimmedName = editLeadName.trim();
                if (!trimmedName) return;
                if (trimmedName !== selectedLead) {
                    onRenameLineLead(selectedLead, trimmedName);
                    setSelectedLead(trimmedName);
                }
                onUpdateLineLeadNotes(trimmedName, editLeadNotes);
                setIsEditingLead(false);
            };

            const handleCancelEditLead = () => {
                setIsEditingLead(false);
                setEditLeadName('');
                setEditLeadNotes('');
            };

            const filteredAssociates = getFilteredAssociates();

            return (
                <div className="setup-form">
                    <div className="form-section">
                        <h3>Manage Core Associates</h3>
                        <p style={{ color: '#6b7280', marginBottom: '12px', fontSize: '12px' }}>
                            Core associates are team members assigned to specific line leads. Tag them with skills and attributes.
                        </p>

                        {/* View Mode Toggle */}
                        <div className="view-mode-toggle">
                            <button
                                className={`view-mode-btn ${viewMode === 'byLead' ? 'active' : ''}`}
                                onClick={() => setViewMode('byLead')}
                            >
                                By Line Lead
                            </button>
                            <button
                                className={`view-mode-btn ${viewMode === 'all' ? 'active' : ''}`}
                                onClick={() => setViewMode('all')}
                            >
                                All Associates
                            </button>
                        </div>

                        {/* Search Box */}
                        {viewMode === 'all' && (
                            <input
                                type="text"
                                className="search-box"
                                placeholder="Search associates by name..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                            />
                        )}

                        {/* By Lead View */}
                        {viewMode === 'byLead' && (
                            <>
                                <div className="form-grid">
                                    <div className="form-group">
                                        <label>Select Existing Lead</label>
                                        <select
                                            value={selectedLead}
                                            onChange={(e) => {
                                                setSelectedLead(e.target.value);
                                                setNewLead('');
                                            }}
                                        >
                                            <option value="">-- Select Lead --</option>
                                            {allLeads.map(lead => (
                                                <option key={lead} value={lead}>{lead}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div style={{ textAlign: 'center', padding: '16px 0', color: '#6b7280' }}>OR</div>
                                    <div className="form-group">
                                        <label>New Lead Name</label>
                                        <input
                                            type="text"
                                            value={newLead}
                                            onChange={(e) => {
                                                setNewLead(e.target.value);
                                                setSelectedLead('');
                                            }}
                                            placeholder="Enter new lead name"
                                        />
                                    </div>
                                </div>

                                {(selectedLead || newLead) && (
                                    <div style={{ marginTop: '20px' }}>
                                        {(isEditingLead && selectedLead) ? (
                                            <div style={{ background: '#f0f2f5', border: '1px solid #d1d5db', borderRadius: '8px', padding: '16px', marginBottom: '16px' }}>
                                                <h4 style={{ marginBottom: '12px', fontSize: '14px' }}>Edit Line Lead</h4>
                                                <div className="form-grid">
                                                    <div className="form-group">
                                                        <label>Lead Name</label>
                                                        <input
                                                            type="text"
                                                            value={editLeadName}
                                                            onChange={(e) => setEditLeadName(e.target.value)}
                                                            placeholder="Lead name"
                                                        />
                                                    </div>
                                                    <div className="form-group">
                                                        <label>Notes</label>
                                                        <textarea
                                                            value={editLeadNotes}
                                                            onChange={(e) => setEditLeadNotes(e.target.value)}
                                                            placeholder="Notes about this line leader..."
                                                            rows="3"
                                                            style={{ resize: 'vertical' }}
                                                        />
                                                    </div>
                                                </div>
                                                <div style={{ display: 'flex', gap: '8px', marginTop: '12px' }}>
                                                    <button className="btn btn-success btn-small" onClick={handleSaveEditLead}>Save</button>
                                                    <button className="btn btn-secondary btn-small" onClick={handleCancelEditLead}>Cancel</button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="lead-header">
                                                <h4 className="lead-title">Core Associates for {selectedLead || newLead}</h4>
                                                {selectedLead && (
                                                    <div style={{ display: 'flex', gap: '4px' }}>
                                                        <button
                                                            className="btn btn-primary btn-small"
                                                            onClick={handleStartEditLead}
                                                        >
                                                            Edit Lead
                                                        </button>
                                                        <button
                                                            className="btn btn-danger btn-small"
                                                            onClick={() => onDeleteLineLead(selectedLead)}
                                                        >
                                                            Delete Lead
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        {!isEditingLead && selectedLead && (lineLeadNotes || {})[selectedLead] && (
                                            <div style={{ background: '#fef9c3', border: '1px solid #fbbf24', borderRadius: '6px', padding: '8px 12px', marginBottom: '12px', fontSize: '12px', color: '#78350f' }}>
                                                <strong>Notes:</strong> {(lineLeadNotes || {})[selectedLead]}
                                            </div>
                                        )}

                                        <form onSubmit={handleAddAssociate}>
                                            <div className="form-grid">
                                                <div className="form-group">
                                                    <label>Associate Name *</label>
                                                    <input
                                                        type="text"
                                                        value={newName}
                                                        onChange={(e) => setNewName(e.target.value)}
                                                        placeholder="Full name"
                                                        required
                                                    />
                                                </div>
                                                <div className="form-group">
                                                    <label>Flags / Skills</label>
                                                    <FlagsDropdown flags={newFlags} onChange={setNewFlags} inForm={true} />
                                                </div>
                                            </div>
                                            <button type="submit" className="btn btn-success">
                                                + Add Core Associate
                                            </button>
                                        </form>
                                    </div>
                                )}
                            </>
                        )}

                        {/* Filters and Sort */}
                        {((viewMode === 'byLead' && (selectedLead || newLead) && (coreAssociates[selectedLead || newLead] || []).length > 0) || (viewMode === 'all' && getAllAssociates().length > 0)) && (
                            <div className="filter-controls">
                                <div className="filter-row">
                                    <span className="filter-label">Sort by:</span>
                                    <select
                                        value={sortBy}
                                        onChange={(e) => setSortBy(e.target.value)}
                                        style={{ padding: '4px 8px', fontSize: '12px', borderRadius: '4px', border: '1px solid #d1d5db' }}
                                    >
                                        <option value="name">Name</option>
                                        {AVAILABLE_FLAGS.map(flag => (
                                            <option key={flag.id} value={flag.id}>{flag.label}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="filter-row" style={{ marginTop: '8px' }}>
                                    <span className="filter-label">Filter by flags:</span>
                                    {AVAILABLE_FLAGS.map(flag => (
                                        <label key={flag.id} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', cursor: 'pointer' }}>
                                            <input
                                                type="checkbox"
                                                checked={filterFlags.includes(flag.id)}
                                                onChange={(e) => {
                                                    if (e.target.checked) {
                                                        setFilterFlags([...filterFlags, flag.id]);
                                                    } else {
                                                        setFilterFlags(filterFlags.filter(f => f !== flag.id));
                                                    }
                                                }}
                                            />
                                            {flag.label}
                                        </label>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Associates List */}
                        {viewMode === 'byLead' ? (
                            // By Lead View
                            (selectedLead || newLead) && (
                                <div className="core-associates-list">
                                    {(coreAssociates[selectedLead || newLead] || []).length === 0 ? (
                                        <p style={{ color: '#6b7280', fontStyle: 'italic', fontSize: '12px' }}>
                                            No core associates yet for this lead.
                                        </p>
                                    ) : filteredAssociates.length === 0 ? (
                                        <p style={{ color: '#6b7280', fontStyle: 'italic', fontSize: '12px' }}>
                                            No associates match the selected filters.
                                        </p>
                                    ) : (
                                        filteredAssociates.map((associate, idx) => {
                                            const originalIndex = (coreAssociates[selectedLead || newLead] || []).findIndex(a => a.name === associate.name);
                                            return (
                                                <div key={idx} className="core-associate-item">
                                                    <div className="core-associate-info">
                                                        <div className="core-associate-name">{associate.name}</div>
                                                        <div className="core-associate-flags">
                                                            {associate.flags && associate.flags.length > 0 ? (
                                                                associate.flags.map(flagId => {
                                                                    const flag = AVAILABLE_FLAGS.find(f => f.id === flagId);
                                                                    return flag ? (
                                                                        <span key={flagId} className={`flag-badge ${flag.className}`}>
                                                                            {flag.label}
                                                                        </span>
                                                                    ) : null;
                                                                })
                                                            ) : (
                                                                <span style={{ fontSize: '11px', color: '#9ca3af', fontStyle: 'italic' }}>No flags</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '4px', flexDirection: 'column' }}>
                                                        <FlagsDropdown
                                                            flags={associate.flags || []}
                                                            onChange={(newFlags) => handleUpdateAssociateFlags(selectedLead || newLead, originalIndex, newFlags)}
                                                        />
                                                        <button
                                                            className="btn btn-danger btn-small"
                                                            onClick={() => onRemoveCoreAssociate(selectedLead || newLead, originalIndex)}
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            )
                        ) : (
                            // All Associates View
                            <div>
                                {allLeads.length === 0 ? (
                                    <p style={{ color: '#6b7280', fontStyle: 'italic', fontSize: '12px', textAlign: 'center', padding: '20px' }}>
                                        No line leads created yet. Switch to "By Line Lead" view to add your first lead and associates.
                                    </p>
                                ) : filteredAssociates.length === 0 ? (
                                    <p style={{ color: '#6b7280', fontStyle: 'italic', fontSize: '12px', textAlign: 'center', padding: '20px' }}>
                                        {searchQuery ? 'No associates match your search.' : 'No associates match the selected filters.'}
                                    </p>
                                ) : (
                                    allLeads.map(lead => {
                                        const leadAssociates = filteredAssociates.filter(a => a.lead === lead);
                                        if (leadAssociates.length === 0) return null;

                                        return (
                                            <div key={lead} className="lead-section">
                                                <div className="lead-header">
                                                    <h4 className="lead-title">{lead}</h4>
                                                    <button
                                                        className="btn btn-danger btn-small"
                                                        onClick={() => onDeleteLineLead(lead)}
                                                    >
                                                        Delete Lead
                                                    </button>
                                                </div>
                                                {(lineLeadNotes || {})[lead] && (
                                                    <div style={{ background: '#fef9c3', border: '1px solid #fbbf24', borderRadius: '6px', padding: '8px 12px', marginBottom: '12px', fontSize: '12px', color: '#78350f' }}>
                                                        <strong>Notes:</strong> {(lineLeadNotes || {})[lead]}
                                                    </div>
                                                )}
                                                <div className="core-associates-list">
                                                    {leadAssociates.map((associate, idx) => (
                                                        <div key={idx} className="core-associate-item">
                                                            <div className="core-associate-info">
                                                                <div className="core-associate-name">{associate.name}</div>
                                                                <div className="core-associate-flags">
                                                                    {associate.flags && associate.flags.length > 0 ? (
                                                                        associate.flags.map(flagId => {
                                                                            const flag = AVAILABLE_FLAGS.find(f => f.id === flagId);
                                                                            return flag ? (
                                                                                <span key={flagId} className={`flag-badge ${flag.className}`}>
                                                                                    {flag.label}
                                                                                </span>
                                                                            ) : null;
                                                                        })
                                                                    ) : (
                                                                        <span style={{ fontSize: '11px', color: '#9ca3af', fontStyle: 'italic' }}>No flags</span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <div style={{ display: 'flex', gap: '4px', flexDirection: 'column' }}>
                                                                <FlagsDropdown
                                                                    flags={associate.flags || []}
                                                                    onChange={(newFlags) => handleUpdateAssociateFlags(associate.lead, associate.leadIndex, newFlags)}
                                                                />
                                                                <button
                                                                    className="btn btn-danger btn-small"
                                                                    onClick={() => onRemoveCoreAssociate(associate.lead, associate.leadIndex)}
                                                                >
                                                                    Remove
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        )}
                    </div>

                    {/* Firebase Connection Status Indicator */}
                    <div className="firebase-status">
                        <div className={`firebase-status-dot ${firebaseStatus}`}></div>
                        <span>
                            {firebaseStatus === 'connected' ? 'Cloud Connected' :
                             firebaseStatus === 'disconnected' ? 'Cloud Disconnected' :
                             'Offline Mode'}
                        </span>
                    </div>
                </div>
            );
        }

        function ComparisonView({ reports, onClose }) {
            const [shiftA, setShiftA] = useState('');
            const [shiftB, setShiftB] = useState('');

            const reportA = reports.find(r => r.id === shiftA);
            const reportB = reports.find(r => r.id === shiftB);

            const getNamesFromReport = (report) => {
                if (!report) return new Set();
                const names = new Set();
                (report.lines || []).forEach(l => {
                    if (!l.isCut) {
                        l.positions.forEach(p => {
                            if (p.name && p.name.trim()) names.add(p.name.trim().toLowerCase());
                        });
                    }
                });
                return names;
            };

            const namesA = getNamesFromReport(reportA);
            const namesB = getNamesFromReport(reportB);
            const allNames = new Set([...namesA, ...namesB]);
            const added = [...allNames].filter(n => !namesA.has(n) && namesB.has(n));
            const removed = [...allNames].filter(n => namesA.has(n) && !namesB.has(n));
            const same = [...allNames].filter(n => namesA.has(n) && namesB.has(n));

            return (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                        <h3>Compare Shifts</h3>
                        <button className="btn btn-secondary btn-small" onClick={onClose}>Back to Reports</button>
                    </div>

                    <div className="form-grid" style={{ marginBottom: '16px' }}>
                        <div className="form-group">
                            <label>Shift A (Before)</label>
                            <select value={shiftA} onChange={(e) => setShiftA(e.target.value)}>
                                <option value="">-- Select --</option>
                                {reports.map(r => (
                                    <option key={r.id} value={r.id}>{r.date} - {r.shift}</option>
                                ))}
                            </select>
                        </div>
                        <div className="form-group">
                            <label>Shift B (After)</label>
                            <select value={shiftB} onChange={(e) => setShiftB(e.target.value)}>
                                <option value="">-- Select --</option>
                                {reports.map(r => (
                                    <option key={r.id} value={r.id}>{r.date} - {r.shift}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    {reportA && reportB && (
                        <>
                            <div className="comparison-stats">
                                <div className="comparison-stat" style={{ background: '#d1fae5', color: '#065f46' }}>
                                    +{added.length} Added
                                </div>
                                <div className="comparison-stat" style={{ background: '#fee2e2', color: '#991b1b' }}>
                                    -{removed.length} Removed
                                </div>
                                <div className="comparison-stat" style={{ background: '#f3f4f6', color: '#374151' }}>
                                    {same.length} Same
                                </div>
                            </div>

                            <div className="comparison-container">
                                <div className="comparison-side">
                                    <h4>{reportA.date} - {reportA.shift} Shift</h4>
                                    {(reportA.lines || []).filter(l => !l.isCut).map((line, i) => (
                                        <div key={i} className="comparison-line">
                                            <strong style={{ fontSize: '12px' }}>Line {line.letter}</strong>
                                            {line.positions.filter(p => p.name && p.name.trim()).map((p, j) => {
                                                const inB = namesB.has(p.name.trim().toLowerCase());
                                                return <span key={j} className={`comparison-name ${inB ? 'same' : 'removed'}`}>{p.name}</span>;
                                            })}
                                        </div>
                                    ))}
                                </div>
                                <div className="comparison-side">
                                    <h4>{reportB.date} - {reportB.shift} Shift</h4>
                                    {(reportB.lines || []).filter(l => !l.isCut).map((line, i) => (
                                        <div key={i} className="comparison-line">
                                            <strong style={{ fontSize: '12px' }}>Line {line.letter}</strong>
                                            {line.positions.filter(p => p.name && p.name.trim()).map((p, j) => {
                                                const inA = namesA.has(p.name.trim().toLowerCase());
                                                return <span key={j} className={`comparison-name ${inA ? 'same' : 'added'}`}>{p.name}</span>;
                                            })}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </>
                    )}

                    {(!reportA || !reportB) && (
                        <div className="empty-state">
                            <p>Select two shifts above to compare them side by side.</p>
                        </div>
                    )}
                </div>
            );
        }

        function AnalyticsView() {
            const [reports, setReports] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadAllReports();
            }, []);

            const loadAllReports = async () => {
                setLoading(true);
                const reportsList = [];
                const seenIds = new Set();

                if (isFirebaseConfigured && db) {
                    try {
                        const snapshot = await db.ref('staffing').once('value');
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            Object.keys(data).forEach(docId => {
                                reportsList.push({ id: docId, ...data[docId] });
                                seenIds.add(docId);
                            });
                        }
                    } catch (error) {
                        console.error('Error loading analytics data:', error);
                    }
                }

                Object.keys(localStorage)
                    .filter(key => key.startsWith('staffing_') && !key.includes('coreAssociates'))
                    .forEach(key => {
                        const data = storage.load(key);
                        if (data && data.date) {
                            const id = data.date + '_' + data.shift;
                            if (!seenIds.has(id)) {
                                reportsList.push({ id: id, ...data });
                                seenIds.add(id);
                            }
                        }
                    });

                reportsList.sort((a, b) => (a.date || '').localeCompare(b.date || ''));
                setReports(reportsList);
                setLoading(false);
            };

            if (loading) {
                return (
                    <div className="empty-state">
                        <p>Loading analytics...</p>
                    </div>
                );
            }

            if (reports.length === 0) {
                return (
                    <div className="empty-state">
                        <h3>No Data Available</h3>
                        <p>Analytics will appear once you have saved staffing sheets.</p>
                    </div>
                );
            }

            // Calculate summary stats
            const totalShifts = reports.length;

            const fillRates = reports.map(r => {
                const lines = (r.lines || []).filter(l => !l.isCut);
                const total = lines.reduce((s, l) => s + (l.needed || l.positions.length), 0);
                const filled = lines.reduce((s, l) => s + l.positions.filter(p => p.name && p.name.trim()).length, 0);
                return total > 0 ? (filled / total) * 100 : 0;
            });
            const avgFillRate = fillRates.length > 0 ? (fillRates.reduce((a, b) => a + b, 0) / fillRates.length) : 0;

            // Most common line letters
            const letterCounts = {};
            reports.forEach(r => {
                (r.lines || []).forEach(l => {
                    const letter = l.letter || '?';
                    letterCounts[letter] = (letterCounts[letter] || 0) + 1;
                });
            });
            const topLetters = Object.entries(letterCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([letter]) => letter)
                .join(', ');

            // Total unique associates
            const uniqueNames = new Set();
            reports.forEach(r => {
                (r.lines || []).forEach(l => l.positions.forEach(p => { if (p.name && p.name.trim()) uniqueNames.add(p.name.trim()); }));
                (r.waitlist || []).forEach(w => { if (w.name && w.name.trim()) uniqueNames.add(w.name.trim()); });
            });

            // Fill rate by week
            const getWeekKey = (dateStr) => {
                const d = new Date(dateStr + 'T00:00:00');
                const yearStart = new Date(d.getFullYear(), 0, 1);
                const weekNum = Math.ceil(((d - yearStart) / 86400000 + yearStart.getDay() + 1) / 7);
                return d.getFullYear() + '-W' + String(weekNum).padStart(2, '0');
            };

            const weeklyRates = {};
            reports.forEach((r, idx) => {
                const week = getWeekKey(r.date || '2000-01-01');
                if (!weeklyRates[week]) weeklyRates[week] = [];
                weeklyRates[week].push(fillRates[idx]);
            });

            const weeklyAvg = Object.entries(weeklyRates)
                .map(([week, rates]) => ({
                    week,
                    avg: rates.reduce((a, b) => a + b, 0) / rates.length
                }))
                .sort((a, b) => a.week.localeCompare(b.week));

            const maxWeeklyRate = Math.max(...weeklyAvg.map(w => w.avg), 1);

            // Line frequency
            const sortedLetters = Object.entries(letterCounts).sort((a, b) => b[1] - a[1]);
            const maxLetterCount = sortedLetters.length > 0 ? sortedLetters[0][1] : 1;

            // Associate frequency
            const assocFreq = {};
            reports.forEach(r => {
                (r.lines || []).forEach(l => {
                    l.positions.forEach(p => {
                        if (p.name && p.name.trim()) {
                            const name = p.name.trim();
                            if (!assocFreq[name]) assocFreq[name] = { count: 0, lastDate: '' };
                            assocFreq[name].count++;
                            if ((r.date || '') > assocFreq[name].lastDate) assocFreq[name].lastDate = r.date || '';
                        }
                    });
                });
                (r.waitlist || []).forEach(w => {
                    if (w.name && w.name.trim()) {
                        const name = w.name.trim();
                        if (!assocFreq[name]) assocFreq[name] = { count: 0, lastDate: '' };
                        assocFreq[name].count++;
                        if ((r.date || '') > assocFreq[name].lastDate) assocFreq[name].lastDate = r.date || '';
                    }
                });
            });
            const sortedAssocs = Object.entries(assocFreq)
                .sort((a, b) => b[1].count - a[1].count);

            return (
                <div>
                    <h3 style={{ marginBottom: '16px' }}>Historical Analytics</h3>

                    <div className="analytics-cards">
                        <div className="analytics-card">
                            <h4>{totalShifts}</h4>
                            <p>Total Shifts Tracked</p>
                        </div>
                        <div className="analytics-card">
                            <h4>{avgFillRate.toFixed(1)}%</h4>
                            <p>Average Fill Rate</p>
                        </div>
                        <div className="analytics-card">
                            <h4>{topLetters || 'N/A'}</h4>
                            <p>Most Common Lines</p>
                        </div>
                        <div className="analytics-card">
                            <h4>{uniqueNames.size}</h4>
                            <p>Total Unique Associates</p>
                        </div>
                    </div>

                    <div style={{ marginBottom: '24px' }}>
                        <h4 style={{ fontSize: '14px', marginBottom: '12px', color: '#111827' }}>Fill Rate by Week</h4>
                        {weeklyAvg.length === 0 ? (
                            <p style={{ color: '#6b7280', fontSize: '12px' }}>No weekly data available.</p>
                        ) : (
                            <div className="bar-chart">
                                {weeklyAvg.map(w => (
                                    <div key={w.week} className="bar-row">
                                        <div className="bar-label">{w.week}</div>
                                        <div className="bar-fill" style={{ width: Math.max((w.avg / maxWeeklyRate) * 100, 5) + '%' }}>
                                            {w.avg.toFixed(1)}%
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <div style={{ marginBottom: '24px' }}>
                        <h4 style={{ fontSize: '14px', marginBottom: '12px', color: '#111827' }}>Line Frequency</h4>
                        {sortedLetters.length === 0 ? (
                            <p style={{ color: '#6b7280', fontSize: '12px' }}>No line data available.</p>
                        ) : (
                            <div className="bar-chart">
                                {sortedLetters.map(([letter, count]) => (
                                    <div key={letter} className="bar-row">
                                        <div className="bar-label">Line {letter}</div>
                                        <div className="bar-fill" style={{ width: Math.max((count / maxLetterCount) * 100, 5) + '%', background: 'linear-gradient(135deg, #f59e0b 0%, #ef4444 100%)' }}>
                                            {count}x
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <div>
                        <h4 style={{ fontSize: '14px', marginBottom: '12px', color: '#111827' }}>Associate Frequency</h4>
                        {sortedAssocs.length === 0 ? (
                            <p style={{ color: '#6b7280', fontSize: '12px' }}>No associate data available.</p>
                        ) : (
                            <div style={{ overflowX: 'auto' }}>
                                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                                    <thead>
                                        <tr style={{ background: '#f3f4f6' }}>
                                            <th style={{ textAlign: 'left', padding: '8px 12px', borderBottom: '1px solid #e5e7eb' }}>Name</th>
                                            <th style={{ textAlign: 'center', padding: '8px 12px', borderBottom: '1px solid #e5e7eb' }}>Shifts Assigned</th>
                                            <th style={{ textAlign: 'center', padding: '8px 12px', borderBottom: '1px solid #e5e7eb' }}>Last Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {sortedAssocs.slice(0, 50).map(([name, info]) => (
                                            <tr key={name} style={{ borderBottom: '1px solid #f3f4f6' }}>
                                                <td style={{ padding: '6px 12px' }}>{name}</td>
                                                <td style={{ textAlign: 'center', padding: '6px 12px', fontWeight: '600', color: '#667eea' }}>{info.count}</td>
                                                <td style={{ textAlign: 'center', padding: '6px 12px', color: '#6b7280' }}>{info.lastDate}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {sortedAssocs.length > 50 && (
                                    <p style={{ textAlign: 'center', padding: '8px', color: '#6b7280', fontSize: '11px' }}>
                                        Showing top 50 of {sortedAssocs.length} associates
                                    </p>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
